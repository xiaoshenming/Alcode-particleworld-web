// 注册所有材质（副作用导入）
import './materials/Empty';
import './materials/Sand';
import './materials/Water';
import './materials/Stone';
import './materials/Wood';
import './materials/Oil';
import './materials/Fire';
import './materials/Smoke';
import './materials/Steam';
import './materials/Acid';
import './materials/Metal';
import './materials/Lava';
import './materials/Seed';
import './materials/Plant';
import './materials/Ice';
import './materials/Snow';
import './materials/Lightning';
import './materials/Glass';
import './materials/Poison';
import './materials/Hydrogen';
import './materials/Dirt';
import './materials/Clay';
import './materials/Gunpowder';
import './materials/Salt';
import './materials/Saltwater';
import './materials/Wax';
import './materials/MoltenWax';
import './materials/Firework';
import './materials/Spark';
import './materials/Putty';
import './materials/Philosopher';
import './materials/Gold';
import './materials/Diamond';
import './materials/Rubber';
import './materials/Cement';
import './materials/Clone';
import './materials/Void';
import './materials/Fountain';
import './materials/Ant';
import './materials/Portal';
import './materials/Magnet';
import './materials/Virus';
import './materials/Wire';
import './materials/Honey';
import './materials/Charcoal';
import './materials/Laser';
import './materials/Moss';
import './materials/Tornado';
import './materials/Foam';
import './materials/Firefly';
import './materials/Crystal';
import './materials/Swamp';
import './materials/Plasma';
import './materials/Mercury';
import './materials/Vine';
import './materials/Meteor';
import './materials/Cobweb';
import './materials/Obsidian';
import './materials/Amber';
import './materials/Phosphorus';
import './materials/Mud';
import './materials/Coral';
import './materials/DryIce';
import './materials/Sulfur';
import './materials/Tar';
import './materials/LiquidNitrogen';
import './materials/Fluorite';
import './materials/Mycelium';
import './materials/Resin';
import './materials/Rust';
import './materials/Bubble';
import './materials/OilSand';
import './materials/Frost';
import './materials/Cloud';
import './materials/Basalt';
import './materials/Tundra';
import './materials/Sodium';
import './materials/GlowLiquid';
import './materials/Termite';
import './materials/Gel';
import './materials/MoltenSalt';
import './materials/Sandstorm';
import './materials/Copper';
import './materials/Tin';
import './materials/Blood';
import './materials/Gear';
import './materials/Slime';
import './materials/Ceramic';
import './materials/Fiber';
import './materials/MoltenGlass';
import './materials/Spore';
import './materials/Thermite';
import './materials/Methane';
import './materials/Ferrofluid';
import './materials/DistilledWater';
import './materials/Quartz';
import './materials/Soda';
import './materials/Mushroom';
import './materials/Snowball';
import './materials/SteamEngine';
import './materials/GoldDust';
import './materials/RainbowLiquid';
import './materials/Bone';
import './materials/Brick';
import './materials/Honeycomb';
import './materials/LiquidHelium';
import './materials/Nitroglycerin';
import './materials/MossyStone';
import './materials/BallLightning';
import './materials/RockSalt';
import './materials/MoltenMetal';
import './materials/Pollen';
import './materials/Pumice';
import './materials/Zeolite';
import './materials/LiquidCrystal';
import './materials/Dolomite';
import './materials/Rocket';
import './materials/DesertRose';
import './materials/Static';
import './materials/OilShale';
import './materials/SteamCloud';
import './materials/Quicklime';
import './materials/Foxfire';
import './materials/Nacre';
import './materials/Diatomite';
import './materials/PlasmaOrb';
import './materials/Coke';
import './materials/Dew';
import './materials/IndustrialMoltenSalt';
import './materials/Aerogel';
import './materials/Phosphor';
import './materials/Hay';
import './materials/LiquidSulfur';
import './materials/SiliconCarbide';
import './materials/Tide';
import './materials/Sphalerite';
import './materials/LiquidOxygen';
import './materials/GlowAlgae';
import './materials/Graphite';
import './materials/Peat';
import './materials/SilicaGel';
import './materials/VolcanicAsh';
import './materials/Arc';
import './materials/DrySand';
import './materials/MagneticSand';
import './materials/MoltenCopper';
import './materials/Muscovite';
import './materials/Niter';
import './materials/Asbestos';
import './materials/CarbonFiber';
import './materials/MoltenAluminum';
import './materials/GlowStick';
import './materials/BlackPowder';
import './materials/Seaweed';
import './materials/MoltenQuartz';
import './materials/Potassium';
import './materials/PhosphoricAcid';
import './materials/Opal';
import './materials/Luminol';
import './materials/DriedVine';
import './materials/SulfuricAcid';
import './materials/Zircon';
import './materials/SteamBubble';
import './materials/Antimony';
import './materials/MoltenAntimony';
import './materials/IceCrystal';
import './materials/MudBrick';
import './materials/FireworkShell';
import './materials/Alcohol';
import './materials/Lye';
import './materials/Gypsum';
import './materials/MoltenIron';
import './materials/FulguriteSand';
import './materials/WhiteTin';
import './materials/MoltenSodium';
import './materials/Limewater';
import './materials/AsphaltLake';
import './materials/Phosphine';
import './materials/Bismuth';
import './materials/MoltenBismuth';
import './materials/NitricAcid';
import './materials/QuartzSand';
import './materials/Magnesium';
import './materials/FlashPowder';
import './materials/Amalgam';
import './materials/Silicon';
import './materials/MoltenSilicon';
import './materials/Permafrost';
import './materials/HydrogenPeroxide';
import './materials/Titanium';
import './materials/MoltenTitanium';
import './materials/PhosphorusFire';
import './materials/Limestone';
import './materials/Alum';
import './materials/Glycerin';
import './materials/CryoFluid';
import './materials/Tungsten';
import './materials/MoltenTungsten';
import './materials/Borax';
import './materials/ElectroPlasma';
import './materials/PeatMoss';
import './materials/LavaRock';
import './materials/Jellyfish';
import './materials/Chromium';
import './materials/MoltenChromium';
import './materials/HydrogenFluoride';
import './materials/Graphene';
import './materials/GlassBead';
import './materials/Manganese';
import './materials/MoltenManganese';
import './materials/SodiumCyanide';
import './materials/Calcite';
import './materials/Thermoplastic';
import './materials/Nickel';
import './materials/MoltenNickel';
import './materials/Formaldehyde';
import './materials/Drywall';
import './materials/ThermalPaste';
import './materials/Zinc';
import './materials/MoltenZinc';
import './materials/Ammonia';
import './materials/DiatomMud';
import './materials/GlowMoss';
import './materials/Lead';
import './materials/MoltenLead';
import './materials/Ozone';
import './materials/VolcanicGlass';
import './materials/Electromagnet';
import './materials/Cobalt';
import './materials/MoltenCobalt';
import './materials/CarbonMonoxide';
import './materials/Slate';
import './materials/PiezoelectricCeramic';
import './materials/TinBronze';
import './materials/MoltenTinBronze';
import './materials/Chlorine';
import './materials/Marble';
import './materials/OpticalFiber';
import './materials/Vanadium';
import './materials/MoltenVanadium';
import './materials/SulfurDioxide';
import './materials/Sandstone';
import './materials/CarbonNanotube';
import './materials/Silver';
import './materials/MoltenSilver';
import './materials/NitrousOxide';
import './materials/Granite';
import './materials/Superconductor';
import './materials/Platinum';
import './materials/MoltenPlatinum';
import './materials/Phosgene';
import './materials/Flint';
import './materials/Nanobot';
import './materials/Molybdenum';
import './materials/MoltenMolybdenum';
import './materials/Argon';
import './materials/Shale';
import './materials/ShapeMemoryAlloy';
import './materials/Hafnium';
import './materials/MoltenHafnium';
import './materials/Xenon';
import './materials/Gneiss';
import './materials/ShapeMemoryPolymer';
import './materials/Iridium';
import './materials/MoltenIridium';
import './materials/Neon';
import './materials/Serpentinite';
import './materials/PiezoFilm';
import './materials/Rhodium';
import './materials/MoltenRhodium';
import './materials/Radon';
import './materials/Diabase';
import './materials/ShapeMemoryCeramic';
import './materials/Niobium';
import './materials/MoltenNiobium';
import './materials/Fluorine';
import './materials/Amphibolite';
import './materials/ConductivePolymer';
import './materials/Palladium';
import './materials/MoltenPalladium';
import './materials/Helium';
import './materials/Schist';
import './materials/Electrochromic';
import './materials/Zirconium';
import './materials/MoltenZirconium';
import './materials/Bromine';
import './materials/Quartzite';
import './materials/Thermoelectric';
import './materials/HafniumAlloy';
import './materials/MoltenHafniumAlloy';
import './materials/Krypton';
import './materials/Hornfels';
import './materials/SelfHealingMaterial';
import './materials/Tantalum';
import './materials/MoltenTantalum';
import './materials/Deuterium';
import './materials/Gabbro';
import './materials/Memristor';
import './materials/RheniumAlloy';
import './materials/MoltenRheniumAlloy';
import './materials/NitrogenTrifluoride';
import './materials/Andesite';
import './materials/PhotochromicMaterial';
import './materials/Thallium';
import './materials/MoltenThallium';
import './materials/Iodine';
import './materials/Granulite';
import './materials/PhotovoltaicMaterial';
import './materials/Osmium';
import './materials/MoltenOsmium';
import './materials/Arsine';
import './materials/Eclogite';
import './materials/FlexCircuit';
import './materials/Indium';
import './materials/MoltenIndium';
import './materials/HydrogenSulfide';
import './materials/Skarn';
import './materials/FlexDisplay';
import './materials/Germanium';
import './materials/MoltenGermanium';
import './materials/HydrogenBromide';
import './materials/Pyroxenite';
import './materials/FlexSolar';
import './materials/Ferroniobium';
import './materials/MoltenFerroniobium';
import './materials/Silane';
import './materials/MetaDiabas';
import './materials/Thermochromic';
import './materials/Dysprosium';
import './materials/MoltenDysprosium';
import './materials/SiliconTetrafluoride';
import './materials/Blueschist';
import './materials/QuantumDot';
import './materials/HafniumTerbiumAlloy';
import './materials/MoltenHafniumTerbium';
import './materials/HydrogenSelenide';
import './materials/MicaSchist';
import './materials/Electroluminescent';
import './materials/Terbium';
import './materials/MoltenTerbium';
import './materials/PhosphorusTrichloride';
import './materials/Phyllite';
import './materials/MagnetostrictiveMaterial';
import './materials/Samarium';
import './materials/MoltenSamarium';
import './materials/SulfurHexafluoride';
import './materials/Breccia';
import './materials/FerroelectricMaterial';
import './materials/Europium';
import './materials/MoltenEuropium';
import './materials/BoronTrifluoride';
import './materials/GneissGranite';
import './materials/PyroelectricMaterial';
import './materials/Cerium';
import './materials/MoltenCerium';
import './materials/CarbonTetrachloride';
import './materials/SerpentinizedPeridotite';
import './materials/ElectrothermalMaterial';
import './materials/Praseodymium';
import './materials/MoltenPraseodymium';
import './materials/PhosphorusPentafluoride';
import './materials/Greenschist';
import './materials/PhotothermalMaterial';
import './materials/Lanthanum';
import './materials/LiquidLanthanum';
import './materials/ArsenicTrifluoride';
import './materials/Pyrophyllite';
import './materials/Sonoluminescent';
import './materials/Neodymium';
import './materials/LiquidNeodymium';
import './materials/TungstenHexafluoride';
import './materials/Hornblende';
import './materials/MagnetoOptical';
import './materials/Gadolinium';
import './materials/LiquidGadolinium';
import './materials/BoronTrichloride';
import './materials/Phyllite';
import './materials/Magnetoresistive';
import './materials/Ytterbium';
import './materials/LiquidYtterbium';
import './materials/GermaniumTetrafluoride';
import './materials/SerpentinizedPeridotite2';
import './materials/ElectrorheologicalFluid';
import './materials/Holmium';
import './materials/LiquidHolmium';
import './materials/PhosphorusPentachloride';
import './materials/SericiteSchist';
import './materials/DielectricElastomer';
import './materials/Thulium';
import './materials/LiquidThulium';
import './materials/SeleniumHexafluoride';
import './materials/MicaGneiss';
import './materials/PhotoelasticMaterial';
import './materials/Erbium';
import './materials/LiquidErbium';
import './materials/ChlorineTrifluoride';
import './materials/Hornfels2';
import './materials/PhotoacousticMaterial';
import './materials/Lutetium';
import './materials/LiquidLutetium';
import './materials/ChlorinePentafluoride';
import './materials/Serpentine';
import './materials/AcoustoOpticMaterial';
import './materials/Ruthenium';
import './materials/LiquidRuthenium';
import './materials/CarbonTetrafluoride';
import './materials/Soapstone';
import './materials/AcoustoElectricMaterial';
import './materials/HafniumRhenium';
import './materials/MoltenHafniumRhenium';
import './materials/XenonDifluoride';
import './materials/Pegmatite';
import './materials/MagnetoelasticMaterial';
import './materials/Thorium';
import './materials/MoltenThorium';
import './materials/IronTrifluoride';
import './materials/Molybdenite';
import './materials/ElectromagneticElastomer';
import './materials/Beryllium';
import './materials/MoltenBeryllium';
import './materials/AmmoniumFluoride';
import './materials/Syenite';
import './materials/PhotomagneticMaterial';
import './materials/Gallium';
import './materials/MoltenGallium';
import './materials/CalciumFluoride';
import './materials/Larvikite';
import './materials/ThermomagneticMaterial';
import './materials/Indium';
import './materials/MoltenIndium';
import './materials/AluminumFluoride';
import './materials/Pyroxenite';
import './materials/PhotoelectricMaterial';
import './materials/Cesium';
import './materials/MoltenCesium';
import './materials/BariumFluoride';
import './materials/Diabase';
import './materials/AcoustomagneticMaterial';
// v34.0 新材质 (ID 441~445)
import './materials/Yttrium';
import './materials/MoltenYttrium';
import './materials/LithiumFluoride';
import './materials/SerpentinizedGabbro';
import './materials/AcoustoelasticMaterial';

import { World } from './core/World';
import { Simulation } from './core/Simulation';
import { Renderer } from './core/Renderer';
import { InputHandler } from './ui/InputHandler';
import { Toolbar } from './ui/Toolbar';
import { InfoPanel } from './ui/InfoPanel';
import { History } from './core/History';
import { FpsGraph } from './ui/FpsGraph';
import { StatsPanel } from './ui/StatsPanel';
import { Encyclopedia } from './ui/Encyclopedia';
import { ScenePanel } from './ui/ScenePresets';
import { SelectionTool } from './ui/SelectionTool';
import { RadialMenu } from './ui/RadialMenu';

import { GifEncoder } from './utils/GifEncoder';
import { getMaterial } from './materials/registry';

const GRID_WIDTH = 200;
const GRID_HEIGHT = 150;
const PIXEL_SCALE = 4;

const canvas = document.getElementById('canvas') as HTMLCanvasElement;
canvas.width = GRID_WIDTH * PIXEL_SCALE;
canvas.height = GRID_HEIGHT * PIXEL_SCALE;

const world = new World(GRID_WIDTH, GRID_HEIGHT);
const simulation = new Simulation(world);
const renderer = new Renderer(canvas, GRID_WIDTH, GRID_HEIGHT, PIXEL_SCALE);
const input = new InputHandler(canvas, world, PIXEL_SCALE);
const history = new History();
const infoPanel = new InfoPanel(canvas, world, PIXEL_SCALE);
const statsPanel = new StatsPanel(world);
const encyclopedia = new Encyclopedia();
const scenePanel = new ScenePanel((preset) => {
  history.pushSnapshot(world.cells);
  preset.generate(world);
});

const selectionTool = new SelectionTool(world);
selectionTool.onSnapshot = () => history.pushSnapshot(world.cells);

const radialMenu = new RadialMenu();

let paused = false;
let simSpeed = 1; // 模拟速度倍率 1~5
let recording = false;
let gifEncoder: GifEncoder | null = null;
let recordFrameCount = 0;
const MAX_GIF_FRAMES = 150; // 最多录制 150 帧（约 5 秒）

// 时间倒流系统
const REWIND_BUFFER_SIZE = 120; // 最多记录 120 帧（约 2 秒）
const rewindBuffer: Uint16Array[] = [];
let rewindHead = 0; // 写入位置
let rewindCount = 0; // 已存帧数
let rewinding = false; // 是否正在倒流
let antiGravity = false; // 反重力模式

// 粒子轨迹追踪系统
let trackingMode = false;   // 是否处于追踪模式（按 L 切换）
let trackingActive = false;  // 是否正在追踪某个粒子
let trackX = -1, trackY = -1;
let trackMatId = 0;          // 被追踪粒子的材质 ID
let trackTrail: Array<{x: number; y: number}> = [];
const TRACK_MAX_TRAIL = 120;

const SAVE_KEY = 'particleworld-save';

// 自动保存系统
const AUTOSAVE_KEY = 'particleworld-autosave';
const AUTOSAVE_INTERVAL = 60_000; // 60秒
const AUTOSAVE_SLOTS = 3; // 3个轮转槽位
let autosaveSlot = 0;
let lastAutosaveTime = Date.now();

/** 执行自动保存（轮转槽位） */
function autosave(): void {
  const data = world.save();
  const key = `${AUTOSAVE_KEY}-${autosaveSlot}`;
  const meta = { slot: autosaveSlot, time: Date.now(), particles: world.getParticleCount() };
  localStorage.setItem(key, data);
  localStorage.setItem(`${AUTOSAVE_KEY}-meta-${autosaveSlot}`, JSON.stringify(meta));
  autosaveSlot = (autosaveSlot + 1) % AUTOSAVE_SLOTS;
  lastAutosaveTime = Date.now();
}

/** 获取所有自动保存槽位信息 */
function getAutosaveSlots(): Array<{slot: number; time: number; particles: number} | null> {
  const slots: Array<{slot: number; time: number; particles: number} | null> = [];
  for (let i = 0; i < AUTOSAVE_SLOTS; i++) {
    try {
      const raw = localStorage.getItem(`${AUTOSAVE_KEY}-meta-${i}`);
      slots.push(raw ? JSON.parse(raw) : null);
    } catch { slots.push(null); }
  }
  return slots;
}

/** 从指定槽位恢复自动保存 */
function loadAutosave(slot: number): boolean {
  const data = localStorage.getItem(`${AUTOSAVE_KEY}-${slot}`);
  if (data) {
    history.pushSnapshot(world.cells);
    return world.load(data);
  }
  return false;
}

// 绘制前保存快照（用于撤销）
input.onPaintStart = () => {
  history.pushSnapshot(world.cells);
};

// 缩放/平移回调
input.screenToGrid = (sx: number, sy: number) => renderer.screenToGrid(sx, sy);

input.onZoom = (delta: number, screenX: number, screenY: number) => {
  const oldZoom = renderer.viewZoom;
  const factor = delta > 0 ? 1.15 : 1 / 1.15;
  const newZoom = Math.max(0.25, Math.min(10, oldZoom * factor));
  // 以鼠标位置为中心缩放
  renderer.viewPanX = screenX - (screenX - renderer.viewPanX) * (newZoom / oldZoom);
  renderer.viewPanY = screenY - (screenY - renderer.viewPanY) * (newZoom / oldZoom);
  renderer.viewZoom = newZoom;
};

input.onPan = (dx: number, dy: number) => {
  renderer.viewPanX += dx;
  renderer.viewPanY += dy;
};

input.onResetView = () => {
  renderer.resetView();
};

const toolbar = new Toolbar(input, {
  onPause: () => { paused = !paused; },
  onClear: () => { world.clear(); history.clear(); },
  onSave: () => {
    localStorage.setItem(SAVE_KEY, world.save());
    // 生成缩略图
    const thumbCanvas = document.createElement('canvas');
    thumbCanvas.width = 80;
    thumbCanvas.height = 60;
    const ctx = thumbCanvas.getContext('2d')!;
    ctx.drawImage(canvas, 0, 0, 80, 60);
    localStorage.setItem(SAVE_KEY + '-thumb', thumbCanvas.toDataURL('image/png', 0.6));
    toolbar.refreshSaveThumbnail();
  },
  onLoad: () => {
    const data = localStorage.getItem(SAVE_KEY);
    if (data) world.load(data);
  },
  onUndo: () => {
    const snapshot = history.undo();
    if (snapshot) world.restoreFromSnapshot(snapshot);
  },
  onRedo: () => {
    const snapshot = history.redo();
    if (snapshot) world.restoreFromSnapshot(snapshot);
  },
  onToggleTempOverlay: () => {
    renderer.showTempOverlay = !renderer.showTempOverlay;
    toolbar.refreshTempOverlay(renderer.showTempOverlay);
  },
  onToggleGrid: () => {
    renderer.showGrid = !renderer.showGrid;
    toolbar.refreshGrid(renderer.showGrid);
  },
  onScreenshot: () => {
    const link = document.createElement('a');
    link.download = `particleworld-${Date.now()}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
  },
  onToggleMirror: () => {
    renderer.showMirrorLine = input.getMirrorMode();
  },
  onSnapshotA: () => canvas.toDataURL('image/png'),
  onSnapshotB: () => canvas.toDataURL('image/png'),
  getParticleCount: () => world.getParticleCount(),
  isPaused: () => paused,
  getSpeed: () => simSpeed,
  setSpeed: (s: number) => { simSpeed = Math.max(1, Math.min(5, s)); },
  setWind: (dir: number, strength: number) => { world.setWind(dir, strength); },
  onCycleWeather: () => {
    simulation.cycleWeather();
    return simulation.getWeatherLabel();
  },
  onToggleRecord: () => {
    if (!recording) {
      gifEncoder = new GifEncoder(GRID_WIDTH, GRID_HEIGHT, 5);
      recordFrameCount = 0;
      recording = true;
    } else {
      finishRecording();
    }
    return recording;
  },
  onExportFile: () => {
    const data = world.save();
    const blob = new Blob([data], { type: 'application/json' });
    const link = document.createElement('a');
    link.download = `particleworld-${Date.now()}.pw`;
    link.href = URL.createObjectURL(blob);
    link.click();
    URL.revokeObjectURL(link.href);
  },
  onImportFile: () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.pw,.json';
    input.addEventListener('change', () => {
      const file = input.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const text = reader.result as string;
        if (world.load(text)) {
          history.clear();
        }
      };
      reader.readAsText(file);
    });
    input.click();
  },
  onEncyclopedia: () => {
    encyclopedia.toggle();
  },
  onToggleAntiGravity: () => {
    antiGravity = !antiGravity;
    return antiGravity;
  },
  onCycleBoundary: () => {
    return simulation.cycleBoundary();
  },
  onToggleDensityMap: () => {
    renderer.showDensityMap = !renderer.showDensityMap;
    return renderer.showDensityMap;
  },
  onToggleAgeOverlay: () => {
    renderer.showAgeOverlay = !renderer.showAgeOverlay;
    return renderer.showAgeOverlay;
  },
  onGetAutosaveSlots: () => {
    return getAutosaveSlots();
  },
  onLoadAutosave: (slot: number) => {
    return loadAutosave(slot);
  },
  getHotkeyBindings: () => {
    return HOTKEY_MATERIALS;
  },
});

// 连接材质选择到轮盘历史记录
toolbar.onMaterialSelect = (matId) => radialMenu.recordUsage(matId);

// 常用材质快捷键映射（数字键 1~9, 0）
const DEFAULT_HOTKEYS = [1, 2, 3, 4, 6, 11, 22, 20, 5, 0]; // 沙水石木火熔岩火药泥土油橡皮
const HOTKEY_STORAGE_KEY = 'pw-hotkey-bindings';
let HOTKEY_MATERIALS = [...DEFAULT_HOTKEYS];

// 从 localStorage 恢复自定义快捷键绑定
try {
  const saved = localStorage.getItem(HOTKEY_STORAGE_KEY);
  if (saved) {
    const parsed = JSON.parse(saved);
    if (Array.isArray(parsed) && parsed.length === 10) {
      HOTKEY_MATERIALS = parsed;
    }
  }
} catch { /* ignore */ }

/** 保存快捷键绑定到 localStorage */
function saveHotkeyBindings(): void {
  localStorage.setItem(HOTKEY_STORAGE_KEY, JSON.stringify(HOTKEY_MATERIALS));
}

// 初始化快捷键栏显示
toolbar.refreshHotkeyBar(HOTKEY_MATERIALS);

// 拖拽导入 .pw 文件
const dropOverlay = document.createElement('div');
dropOverlay.id = 'drop-overlay';
dropOverlay.style.display = 'none';
const dropHint = document.createElement('div');
dropHint.className = 'drop-hint';
dropHint.textContent = '拖放 .pw 文件以导入世界';
dropOverlay.appendChild(dropHint);
document.body.appendChild(dropOverlay);

let dragCounter = 0;
document.addEventListener('dragenter', (e) => {
  e.preventDefault();
  dragCounter++;
  dropOverlay.style.display = 'flex';
});
document.addEventListener('dragleave', (e) => {
  e.preventDefault();
  dragCounter--;
  if (dragCounter <= 0) {
    dragCounter = 0;
    dropOverlay.style.display = 'none';
  }
});
document.addEventListener('dragover', (e) => {
  e.preventDefault();
});
document.addEventListener('drop', (e) => {
  e.preventDefault();
  dragCounter = 0;
  dropOverlay.style.display = 'none';
  const file = e.dataTransfer?.files[0];
  if (!file) return;
  if (!file.name.endsWith('.pw') && !file.name.endsWith('.json')) return;
  const reader = new FileReader();
  reader.onload = () => {
    const text = reader.result as string;
    if (world.load(text)) {
      history.clear();
    }
  };
  reader.readAsText(file);
});

// 快捷键
document.addEventListener('keydown', (e) => {
  // Escape 关闭弹出面板
  if (e.code === 'Escape') {
    if (selectionTool.active) {
      selectionTool.cancel();
      selectionTool.active = false;
      return;
    }
    if (scenePanel.isVisible()) { scenePanel.hide(); return; }
    if (radialMenu.isVisible()) { radialMenu.hide(); return; }
  }

  // ` 键（反引号）打开材质快速轮盘
  if (e.code === 'Backquote' && !radialMenu.isVisible()) {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const cx = rect.left + rect.width / 2;
    const cy = rect.top + rect.height / 2;
    radialMenu.show(cx, cy, (matId) => {
      input.setMaterial(matId);
      radialMenu.recordUsage(matId);
      toolbar.refreshMaterialSelection();
    });
    return;
  }

  // I 键切换选区模式
  if (e.code === 'KeyI') {
    selectionTool.toggle();
    return;
  }

  // 选区模式下的快捷键
  if (selectionTool.active) {
    // Ctrl+C 复制
    if ((e.ctrlKey || e.metaKey) && e.code === 'KeyC') {
      e.preventDefault();
      selectionTool.copy();
      return;
    }
    // Ctrl+X 剪切
    if ((e.ctrlKey || e.metaKey) && e.code === 'KeyX') {
      e.preventDefault();
      selectionTool.cut();
      return;
    }
    // Ctrl+V 粘贴
    if ((e.ctrlKey || e.metaKey) && e.code === 'KeyV') {
      e.preventDefault();
      selectionTool.paste();
      return;
    }
    // Delete 删除选区
    if (e.code === 'Delete' || e.code === 'Backspace') {
      e.preventDefault();
      selectionTool.deleteSelection();
      return;
    }
    // 方向键微调浮动选区
    if (e.code === 'ArrowUp') { e.preventDefault(); selectionTool.nudge(0, -1); return; }
    if (e.code === 'ArrowDown') { e.preventDefault(); selectionTool.nudge(0, 1); return; }
    if (e.code === 'ArrowLeft') { e.preventDefault(); selectionTool.nudge(-1, 0); return; }
    if (e.code === 'ArrowRight') { e.preventDefault(); selectionTool.nudge(1, 0); return; }
  }

  // Backspace 按住倒流
  if (e.code === 'Backspace') {
    e.preventDefault();
    if (!rewinding && rewindCount > 0) {
      rewinding = true;
    }
    return;
  }

  // Ctrl+Z 撤销 / Ctrl+Y 或 Ctrl+Shift+Z 重做
  if ((e.ctrlKey || e.metaKey) && e.code === 'KeyZ' && !e.shiftKey) {
    e.preventDefault();
    const snapshot = history.undo();
    if (snapshot) world.restoreFromSnapshot(snapshot);
    return;
  }
  if ((e.ctrlKey || e.metaKey) && (e.code === 'KeyY' || (e.code === 'KeyZ' && e.shiftKey))) {
    e.preventDefault();
    const snapshot = history.redo();
    if (snapshot) world.restoreFromSnapshot(snapshot);
    return;
  }

  // Ctrl+F 聚焦材质搜索框
  if ((e.ctrlKey || e.metaKey) && e.code === 'KeyF') {
    e.preventDefault();
    toolbar.focusSearch();
    return;
  }

  // Space 暂停
  if (e.code === 'Space') {
    e.preventDefault();
    paused = !paused;
    return;
  }

  // Shift+数字键 绑定当前材质到快捷键
  if (e.shiftKey && e.code >= 'Digit1' && e.code <= 'Digit9') {
    const idx = parseInt(e.code.charAt(5)) - 1;
    HOTKEY_MATERIALS[idx] = input.getMaterial();
    saveHotkeyBindings();
    toolbar.refreshHotkeyBar(HOTKEY_MATERIALS);
    return;
  }
  if (e.shiftKey && e.code === 'Digit0') {
    HOTKEY_MATERIALS[9] = input.getMaterial();
    saveHotkeyBindings();
    toolbar.refreshHotkeyBar(HOTKEY_MATERIALS);
    return;
  }

  // 数字键 1~9, 0 选材质
  if (e.code >= 'Digit1' && e.code <= 'Digit9') {
    const idx = parseInt(e.code.charAt(5)) - 1;
    if (idx < HOTKEY_MATERIALS.length) {
      input.setMaterial(HOTKEY_MATERIALS[idx]);
      toolbar.refreshMaterialSelection();
    }
    return;
  }
  if (e.code === 'Digit0') {
    input.setMaterial(HOTKEY_MATERIALS[9]);
    toolbar.refreshMaterialSelection();
    return;
  }

  // [ ] 调笔刷大小
  if (e.code === 'BracketLeft') {
    input.setBrushSize(input.getBrushSize() - 1);
    toolbar.refreshBrushSize();
    return;
  }
  if (e.code === 'BracketRight') {
    input.setBrushSize(input.getBrushSize() + 1);
    toolbar.refreshBrushSize();
    return;
  }

  // - = 调速度
  if (e.code === 'Minus') {
    simSpeed = Math.max(1, simSpeed - 1);
    toolbar.refreshSpeed(simSpeed);
    return;
  }
  if (e.code === 'Equal') {
    simSpeed = Math.min(5, simSpeed + 1);
    toolbar.refreshSpeed(simSpeed);
    return;
  }

  // T 键切换温度可视化
  if (e.code === 'KeyT') {
    renderer.showTempOverlay = !renderer.showTempOverlay;
    toolbar.refreshTempOverlay(renderer.showTempOverlay);
    return;
  }

  // G 键切换网格线
  if (e.code === 'KeyG') {
    renderer.showGrid = !renderer.showGrid;
    toolbar.refreshGrid(renderer.showGrid);
    return;
  }

  // B 键切换笔刷形状
  if (e.code === 'KeyB') {
    const shapes = ['circle', 'square', 'line', 'spray'] as const;
    const current = input.getBrushShape();
    const idx = shapes.indexOf(current);
    const next = shapes[(idx + 1) % shapes.length];
    input.setBrushShape(next);
    toolbar.refreshBrushShape();
    return;
  }

  // E 键切换橡皮擦
  if (e.code === 'KeyE') {
    if (input.getMaterial() === 0) {
      input.setMaterial(1); // 切回沙子
    } else {
      input.setMaterial(0);
    }
    toolbar.refreshMaterialSelection();
    return;
  }

  // F 键切换填充模式
  if (e.code === 'KeyF') {
    const current = input.getDrawMode();
    input.setDrawMode(current === 'fill' ? 'brush' : 'fill');
    toolbar.refreshDrawMode();
    return;
  }

  // X 键切换替换模式
  if (e.code === 'KeyX') {
    const current = input.getDrawMode();
    input.setDrawMode(current === 'replace' ? 'brush' : 'replace');
    toolbar.refreshDrawMode();
    return;
  }

  // R 键切换随机材质模式
  if (e.code === 'KeyR') {
    input.setRandomMode(!input.getRandomMode());
    toolbar.refreshRandomMode();
    return;
  }

  // Q 键顺时针旋转世界 90°
  if (e.code === 'KeyQ') {
    world.rotateCW();
    return;
  }

  // W 键循环切换天气
  if (e.code === 'KeyW') {
    const label = simulation.cycleWeather();
    toolbar.refreshWeather(label);
    return;
  }

  // S 键切换材质统计面板
  if (e.code === 'KeyS') {
    statsPanel.toggle();
    return;
  }

  // H 键打开材质百科全书
  if (e.code === 'KeyH') {
    encyclopedia.toggle();
    return;
  }

  // K 键打开场景预设面板
  if (e.code === 'KeyK') {
    scenePanel.toggle();
    return;
  }

  // M 键切换镜像绘制模式
  if (e.code === 'KeyM') {
    input.setMirrorMode(!input.getMirrorMode());
    renderer.showMirrorLine = input.getMirrorMode();
    toolbar.refreshMirrorMode();
    return;
  }

  // N 键切换混合笔刷模式
  if (e.code === 'KeyN') {
    input.setMixBrush(!input.getMixBrush());
    toolbar.refreshMixBrush();
    return;
  }

  // L 键切换粒子轨迹追踪模式
  if (e.code === 'KeyL') {
    if (trackingActive) {
      // 正在追踪时按 L 停止追踪并退出追踪模式
      trackingActive = false;
      trackingMode = false;
      trackTrail = [];
    } else {
      trackingMode = !trackingMode;
    }
    return;
  }

  // D 键循环喷雾密度 (20% → 40% → 60% → 80% → 100% → 20%)
  if (e.code === 'KeyD') {
    const current = Math.round(input.getSprayDensity() * 100);
    const steps = [20, 40, 60, 80, 100];
    const idx = steps.indexOf(current);
    const next = steps[(idx + 1) % steps.length];
    input.setSprayDensity(next / 100);
    toolbar.refreshSprayDensity();
    return;
  }

  // G 键切换渐变笔刷
  if (e.code === 'KeyG') {
    input.setGradientBrush(!input.getGradientBrush());
    toolbar.refreshGradientBrush();
    return;
  }

  // V 键切换反重力模式
  if (e.code === 'KeyV') {
    antiGravity = !antiGravity;
    toolbar.refreshAntiGravity(antiGravity);
    return;
  }

  // , 键降低温度笔刷温度 / . 键升高温度笔刷温度
  if (e.code === 'Comma') {
    const current = input.getBrushTemp();
    if (current <= 0) {
      input.setBrushTemp(100);
    } else {
      input.setBrushTemp(Math.max(0, current - 100));
    }
    toolbar.refreshBrushTemp();
    return;
  }
  if (e.code === 'Period') {
    const current = input.getBrushTemp();
    input.setBrushTemp(current + 100);
    toolbar.refreshBrushTemp();
    return;
  }

  // J 键切换边界模式
  if (e.code === 'KeyJ') {
    const mode = simulation.cycleBoundary();
    toolbar.refreshBoundary(mode);
    return;
  }

  // Y 键切换密度热力图
  if (e.code === 'KeyY') {
    renderer.showDensityMap = !renderer.showDensityMap;
    toolbar.refreshDensityMap(renderer.showDensityMap);
    return;
  }

  // A 键切换年龄叠加层
  if (e.code === 'KeyA') {
    renderer.showAgeOverlay = !renderer.showAgeOverlay;
    toolbar.refreshAgeOverlay(renderer.showAgeOverlay);
    return;
  }

  // T 键切换粒子轨迹叠加层
  if (e.code === 'KeyT') {
    renderer.showTrailOverlay = !renderer.showTrailOverlay;
    return;
  }

  // U 键切换温度计 HUD
  if (e.code === 'KeyU') {
    renderer.showThermometer = !renderer.showThermometer;
    return;
  }

  // Shift+Arrow 翻转世界
  if (e.shiftKey && e.code === 'ArrowUp') {
    e.preventDefault();
    world.flipVertical();
    return;
  }
  if (e.shiftKey && e.code === 'ArrowDown') {
    e.preventDefault();
    world.flipVertical();
    return;
  }
  if (e.shiftKey && e.code === 'ArrowLeft') {
    e.preventDefault();
    world.flipHorizontal();
    return;
  }
  if (e.shiftKey && e.code === 'ArrowRight') {
    e.preventDefault();
    world.flipHorizontal();
    return;
  }

  // Home 键重置视图缩放/平移
  if (e.code === 'Home') {
    renderer.resetView();
    return;
  }

  // P 键截图
  if (e.code === 'KeyP') {
    const link = document.createElement('a');
    link.download = `particleworld-${Date.now()}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
    return;
  }
});

document.addEventListener('keyup', (e) => {
  if (e.code === 'Backspace') {
    rewinding = false;
  }
});

// 小地图点击拦截（capture 阶段优先处理）
canvas.addEventListener('mousedown', (e) => {
  const rect = canvas.getBoundingClientRect();
  if (renderer.minimapClick(e.clientX - rect.left, e.clientY - rect.top)) {
    e.stopPropagation();
  }
}, true);

// 选区工具鼠标事件拦截（capture 阶段）
canvas.addEventListener('mousedown', (e) => {
  if (!selectionTool.active || e.button !== 0) return;
  const rect = canvas.getBoundingClientRect();
  const [gx, gy] = renderer.screenToGrid(e.clientX - rect.left, e.clientY - rect.top);
  if (selectionTool.mouseDown(gx, gy)) {
    e.stopPropagation();
    e.preventDefault();
  }
}, true);

canvas.addEventListener('mousemove', (e) => {
  if (!selectionTool.active) return;
  const rect = canvas.getBoundingClientRect();
  const [gx, gy] = renderer.screenToGrid(e.clientX - rect.left, e.clientY - rect.top);
  selectionTool.mouseMove(gx, gy);
});

canvas.addEventListener('mouseup', () => {
  if (!selectionTool.active) return;
  selectionTool.mouseUp();
});

// 追踪模式下点击选择粒子
canvas.addEventListener('mousedown', (e) => {
  if (!trackingMode || e.button !== 0) return;
  const rect = canvas.getBoundingClientRect();
  const [gx, gy] = renderer.screenToGrid(e.clientX - rect.left, e.clientY - rect.top);
  if (!world.inBounds(gx, gy)) return;
  const matId = world.get(gx, gy);
  if (matId === 0) {
    // 点击空白处停止追踪
    trackingActive = false;
    trackingMode = false;
    trackTrail = [];
    return;
  }
  // 开始追踪该粒子
  trackX = gx;
  trackY = gy;
  trackMatId = matId;
  trackTrail = [{x: gx, y: gy}];
  trackingActive = true;
  e.stopPropagation();
  e.preventDefault();
}, true);

// 录制完成：编码并下载 GIF
function finishRecording(): void {
  if (gifEncoder) {
    const blob = gifEncoder.encode();
    const link = document.createElement('a');
    link.download = `particleworld-${Date.now()}.gif`;
    link.href = URL.createObjectURL(blob);
    link.click();
    URL.revokeObjectURL(link.href);
    gifEncoder = null;
  }
  recording = false;
  recordFrameCount = 0;
  toolbar.refreshRecord(false);
}

// GIF 录制用的缩小 canvas（原始分辨率，不含 UI）
const gifCanvas = document.createElement('canvas');
gifCanvas.width = GRID_WIDTH;
gifCanvas.height = GRID_HEIGHT;
const gifCtx = gifCanvas.getContext('2d')!;

// FPS 图表
const fpsGraph = new FpsGraph();

function loop() {
  if (rewinding) {
    // 倒流模式：从缓冲区回放
    if (rewindCount > 0) {
      rewindHead = (rewindHead - 1 + REWIND_BUFFER_SIZE) % REWIND_BUFFER_SIZE;
      rewindCount--;
      world.restoreFromSnapshot(rewindBuffer[rewindHead]);
    }
  } else if (!paused) {
    // 正常模拟：记录帧到环形缓冲区
    for (let i = 0; i < simSpeed; i++) {
      // 每步模拟前记录快照
      if (!rewindBuffer[rewindHead]) {
        rewindBuffer[rewindHead] = new Uint16Array(world.cells.length);
      }
      rewindBuffer[rewindHead].set(world.cells);
      rewindHead = (rewindHead + 1) % REWIND_BUFFER_SIZE;
      if (rewindCount < REWIND_BUFFER_SIZE) rewindCount++;

      simulation.update();
      // 反重力：模拟后翻转世界，下一帧模拟前再翻转回来
      // 效果：粒子看起来向上运动
    }
    if (antiGravity) {
      world.flipVertical();
    }

    // 轨迹衰减
    if (renderer.showTrailOverlay) {
      world.decayTrail();
    }

    // 粒子轨迹追踪：每帧更新追踪位置
    if (trackingActive) {
      const curMat = world.get(trackX, trackY);
      if (curMat === trackMatId) {
        // 粒子还在原位，直接记录
        trackTrail.push({x: trackX, y: trackY});
      } else {
        // 粒子移动了，在邻域搜索相同材质
        let found = false;
        for (let r = 1; r <= 4 && !found; r++) {
          for (let dy = -r; dy <= r && !found; dy++) {
            for (let dx = -r; dx <= r && !found; dx++) {
              if (Math.abs(dx) !== r && Math.abs(dy) !== r) continue; // 只搜外圈
              const nx = trackX + dx, ny = trackY + dy;
              if (world.inBounds(nx, ny) && world.get(nx, ny) === trackMatId) {
                trackX = nx;
                trackY = ny;
                found = true;
              }
            }
          }
        }
        if (found) {
          trackTrail.push({x: trackX, y: trackY});
        } else {
          // 粒子消失，停止追踪
          trackingActive = false;
          trackingMode = false;
          trackTrail = [];
        }
      }
      if (trackingActive && trackTrail.length > TRACK_MAX_TRAIL) {
        trackTrail.shift();
      }
    }
  }
  renderer.render(world);

  // 粒子轨迹绘制
  if (trackingActive && trackTrail.length >= 2) {
    renderer.renderTrail(trackTrail);
    const mat = getMaterial(world.get(trackX, trackY));
    renderer.renderTrackInfo(trackX, trackY, mat?.name || '未知');
  } else if (trackingMode && !trackingActive) {
    // 追踪模式但未选择粒子，显示提示
    renderer.renderTrackInfo(-1, -1, '点击粒子开始追踪');
  }

  // GIF 录制：每 3 帧捕获一次（降低文件大小）
  if (recording && gifEncoder && !paused) {
    if (recordFrameCount % 3 === 0) {
      gifCtx.drawImage(canvas, 0, 0, GRID_WIDTH, GRID_HEIGHT);
      gifEncoder.addFrame(gifCanvas);
    }
    recordFrameCount++;
    if (recordFrameCount >= MAX_GIF_FRAMES) {
      finishRecording();
    }
  }

  // 选区工具渲染
  if (selectionTool.active) {
    if (selectionTool.rect) {
      const r = selectionTool.rect;
      renderer.renderSelectionRect(r.x, r.y, r.w, r.h);
    }
    if (selectionTool.floating) {
      const f = selectionTool.floating;
      renderer.renderFloatingSelection(selectionTool.floatingX, selectionTool.floatingY, f.w, f.h, f.cells);
    }
    const hint = selectionTool.floating
      ? '选区模式 | 点击放置 | 方向键微调 | Esc退出'
      : selectionTool.rect
        ? '选区模式 | Ctrl+C复制 Ctrl+X剪切 Del删除 | Esc退出'
        : '选区模式 | 拖拽框选 | Ctrl+V粘贴 | Esc退出';
    renderer.renderSelectionHint(hint);
  }

  // 笔刷预览
  if (input.cursorVisible) {
    renderer.renderBrushPreview(input.cursorX, input.cursorY, input.getBrushSize(), input.getBrushShape(), input.getGradientBrush(), input.getBrushAngle());
    // 线条模式预览
    if (input.isDrawingLine()) {
      const [lx, ly] = input.getLineStart();
      renderer.renderLinePreview(lx, ly, input.cursorX, input.cursorY);
    }
  }

  // 温度计 HUD
  if (renderer.showThermometer && input.cursorVisible) {
    const gx = input.cursorX, gy = input.cursorY;
    if (world.inBounds(gx, gy)) {
      const temp = world.getTemp(gx, gy);
      const matId = world.get(gx, gy);
      const mat = getMaterial(matId);
      const name = mat ? mat.name : '空气';
      const sx = (gx + 0.5) * PIXEL_SCALE * renderer.viewZoom + renderer.viewPanX;
      const sy = (gy + 0.5) * PIXEL_SCALE * renderer.viewZoom + renderer.viewPanY;
      renderer.renderThermometer(sx, sy, temp, name);
    }
  }

  toolbar.updateStats();
  infoPanel.update();
  statsPanel.update();
  fpsGraph.tick();

  // 自动保存（每60秒）
  if (Date.now() - lastAutosaveTime >= AUTOSAVE_INTERVAL && !paused) {
    autosave();
  }

  requestAnimationFrame(loop);
}

requestAnimationFrame(loop);
