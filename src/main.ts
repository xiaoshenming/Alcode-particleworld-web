// 注册所有材质（副作用导入）
import './materials/Empty';
import './materials/Sand';
import './materials/Water';
import './materials/Stone';
import './materials/Wood';
import './materials/Oil';
import './materials/Fire';
import './materials/Smoke';
import './materials/Steam';
import './materials/Acid';
import './materials/Metal';
import './materials/Lava';
import './materials/Seed';
import './materials/Plant';
import './materials/Ice';
import './materials/Snow';
import './materials/Lightning';
import './materials/Glass';
import './materials/Poison';
import './materials/Hydrogen';
import './materials/Dirt';
import './materials/Clay';
import './materials/Gunpowder';
import './materials/Salt';
import './materials/Saltwater';
import './materials/Wax';
import './materials/MoltenWax';
import './materials/Firework';
import './materials/Spark';
import './materials/Putty';
import './materials/Philosopher';
import './materials/Gold';
import './materials/Diamond';
import './materials/Rubber';
import './materials/Cement';
import './materials/Clone';
import './materials/Void';
import './materials/Fountain';
import './materials/Ant';
import './materials/Portal';
import './materials/Magnet';
import './materials/Virus';
import './materials/Wire';
import './materials/Honey';
import './materials/Charcoal';
import './materials/Laser';
import './materials/Moss';
import './materials/Tornado';
import './materials/Foam';
import './materials/Firefly';
import './materials/Crystal';
import './materials/Swamp';
import './materials/Plasma';
import './materials/Mercury';
import './materials/Vine';
import './materials/Meteor';
import './materials/Cobweb';
import './materials/Obsidian';
import './materials/Amber';
import './materials/Phosphorus';
import './materials/Mud';
import './materials/Coral';
import './materials/DryIce';
import './materials/Sulfur';
import './materials/Tar';
import './materials/LiquidNitrogen';
import './materials/Fluorite';
import './materials/Mycelium';
import './materials/Resin';
import './materials/Rust';
import './materials/Bubble';
import './materials/OilSand';
import './materials/Frost';
import './materials/Cloud';
import './materials/Basalt';
import './materials/Tundra';
import './materials/Sodium';
import './materials/GlowLiquid';
import './materials/Termite';
import './materials/Gel';
import './materials/MoltenSalt';
import './materials/Sandstorm';
import './materials/Copper';
import './materials/Tin';
import './materials/Blood';
import './materials/Gear';
import './materials/Slime';
import './materials/Ceramic';
import './materials/Fiber';
import './materials/MoltenGlass';
import './materials/Spore';
import './materials/Thermite';
import './materials/Methane';
import './materials/Ferrofluid';
import './materials/DistilledWater';
import './materials/Quartz';
import './materials/Soda';
import './materials/Mushroom';
import './materials/Snowball';
import './materials/SteamEngine';
import './materials/GoldDust';
import './materials/RainbowLiquid';
import './materials/Bone';
import './materials/Brick';
import './materials/Honeycomb';
import './materials/LiquidHelium';
import './materials/Nitroglycerin';
import './materials/MossyStone';
import './materials/BallLightning';
import './materials/RockSalt';
import './materials/MoltenMetal';
import './materials/Pollen';
import './materials/Pumice';
import './materials/Zeolite';
import './materials/LiquidCrystal';
import './materials/Dolomite';
import './materials/Rocket';
import './materials/DesertRose';
import './materials/Static';
import './materials/OilShale';
import './materials/SteamCloud';
import './materials/Quicklime';
import './materials/Foxfire';
import './materials/Nacre';
import './materials/Diatomite';
import './materials/PlasmaOrb';
import './materials/Coke';
import './materials/Dew';
import './materials/IndustrialMoltenSalt';
import './materials/Aerogel';
import './materials/Phosphor';
import './materials/Hay';
import './materials/LiquidSulfur';
import './materials/SiliconCarbide';
import './materials/Tide';
import './materials/Sphalerite';
import './materials/LiquidOxygen';
import './materials/GlowAlgae';
import './materials/Graphite';
import './materials/Peat';
import './materials/SilicaGel';
import './materials/VolcanicAsh';
import './materials/Arc';
import './materials/DrySand';
import './materials/MagneticSand';
import './materials/MoltenCopper';
import './materials/Muscovite';
import './materials/Niter';
import './materials/Asbestos';
import './materials/CarbonFiber';
import './materials/MoltenAluminum';
import './materials/GlowStick';
import './materials/BlackPowder';
import './materials/Seaweed';
import './materials/MoltenQuartz';
import './materials/Potassium';
import './materials/PhosphoricAcid';
import './materials/Opal';
import './materials/Luminol';
import './materials/DriedVine';
import './materials/SulfuricAcid';
import './materials/Zircon';
import './materials/SteamBubble';
import './materials/Antimony';
import './materials/MoltenAntimony';
import './materials/IceCrystal';
import './materials/MudBrick';
import './materials/FireworkShell';
import './materials/Alcohol';
import './materials/Lye';
import './materials/Gypsum';
import './materials/MoltenIron';
import './materials/FulguriteSand';
import './materials/WhiteTin';
import './materials/MoltenSodium';
import './materials/Limewater';
import './materials/AsphaltLake';
import './materials/Phosphine';
import './materials/Bismuth';
import './materials/MoltenBismuth';
import './materials/NitricAcid';
import './materials/QuartzSand';
import './materials/Magnesium';
import './materials/FlashPowder';
import './materials/Amalgam';
import './materials/Silicon';
import './materials/MoltenSilicon';
import './materials/Permafrost';
import './materials/HydrogenPeroxide';
import './materials/Titanium';
import './materials/MoltenTitanium';
import './materials/PhosphorusFire';
import './materials/Limestone';
import './materials/Alum';
import './materials/Glycerin';
import './materials/CryoFluid';
import './materials/Tungsten';
import './materials/MoltenTungsten';
import './materials/Borax';
import './materials/ElectroPlasma';
import './materials/PeatMoss';
import './materials/LavaRock';
import './materials/Jellyfish';
import './materials/Chromium';
import './materials/MoltenChromium';
import './materials/HydrogenFluoride';
import './materials/Graphene';
import './materials/GlassBead';
import './materials/Manganese';
import './materials/MoltenManganese';
import './materials/SodiumCyanide';
import './materials/Calcite';
import './materials/Thermoplastic';
import './materials/Nickel';
import './materials/MoltenNickel';
import './materials/Formaldehyde';
import './materials/Drywall';
import './materials/ThermalPaste';
import './materials/Zinc';
import './materials/MoltenZinc';
import './materials/Ammonia';
import './materials/DiatomMud';
import './materials/GlowMoss';
import './materials/Lead';
import './materials/MoltenLead';
import './materials/Ozone';
import './materials/VolcanicGlass';
import './materials/Electromagnet';
import './materials/Cobalt';
import './materials/MoltenCobalt';
import './materials/CarbonMonoxide';
import './materials/Slate';
import './materials/PiezoelectricCeramic';
import './materials/TinBronze';
import './materials/MoltenTinBronze';
import './materials/Chlorine';
import './materials/Marble';
import './materials/OpticalFiber';
import './materials/Vanadium';
import './materials/MoltenVanadium';
import './materials/SulfurDioxide';
import './materials/Sandstone';
import './materials/CarbonNanotube';
import './materials/Silver';
import './materials/MoltenSilver';
import './materials/NitrousOxide';
import './materials/Granite';
import './materials/Superconductor';
import './materials/Platinum';
import './materials/MoltenPlatinum';
import './materials/Phosgene';
import './materials/Flint';
import './materials/Nanobot';
import './materials/Molybdenum';
import './materials/MoltenMolybdenum';
import './materials/Argon';
import './materials/Shale';
import './materials/ShapeMemoryAlloy';
import './materials/Hafnium';
import './materials/MoltenHafnium';
import './materials/Xenon';
import './materials/Gneiss';
import './materials/ShapeMemoryPolymer';
import './materials/Iridium';
import './materials/MoltenIridium';
import './materials/Neon';
import './materials/Serpentinite';
import './materials/PiezoFilm';
import './materials/Rhodium';
import './materials/MoltenRhodium';
import './materials/Radon';
import './materials/Diabase';
import './materials/ShapeMemoryCeramic';
import './materials/Niobium';
import './materials/MoltenNiobium';
import './materials/Fluorine';
import './materials/Amphibolite';
import './materials/ConductivePolymer';
import './materials/Palladium';
import './materials/MoltenPalladium';
import './materials/Helium';
import './materials/Schist';
import './materials/Electrochromic';
import './materials/Zirconium';
import './materials/MoltenZirconium';
import './materials/Bromine';
import './materials/Quartzite';
import './materials/Thermoelectric';
import './materials/HafniumAlloy';
import './materials/MoltenHafniumAlloy';
import './materials/Krypton';
import './materials/Hornfels';
import './materials/SelfHealingMaterial';
import './materials/Tantalum';
import './materials/MoltenTantalum';
import './materials/Deuterium';
import './materials/Gabbro';
import './materials/Memristor';
import './materials/RheniumAlloy';
import './materials/MoltenRheniumAlloy';
import './materials/NitrogenTrifluoride';
import './materials/Andesite';
import './materials/PhotochromicMaterial';
import './materials/Thallium';
import './materials/MoltenThallium';
import './materials/Iodine';
import './materials/Granulite';
import './materials/PhotovoltaicMaterial';
import './materials/Osmium';
import './materials/MoltenOsmium';
import './materials/Arsine';
import './materials/Eclogite';
import './materials/FlexCircuit';
import './materials/Indium';
import './materials/MoltenIndium';
import './materials/HydrogenSulfide';
import './materials/Skarn';
import './materials/FlexDisplay';
import './materials/Germanium';
import './materials/MoltenGermanium';
import './materials/HydrogenBromide';
import './materials/Pyroxenite';
import './materials/FlexSolar';
import './materials/Ferroniobium';
import './materials/MoltenFerroniobium';
import './materials/Silane';
import './materials/MetaDiabas';
import './materials/Thermochromic';
import './materials/Dysprosium';
import './materials/MoltenDysprosium';
import './materials/SiliconTetrafluoride';
import './materials/Blueschist';
import './materials/QuantumDot';
import './materials/HafniumTerbiumAlloy';
import './materials/MoltenHafniumTerbium';
import './materials/HydrogenSelenide';
import './materials/MicaSchist';
import './materials/Electroluminescent';
import './materials/Terbium';
import './materials/MoltenTerbium';
import './materials/PhosphorusTrichloride';
import './materials/Phyllite';
import './materials/MagnetostrictiveMaterial';
import './materials/Samarium';
import './materials/MoltenSamarium';
import './materials/SulfurHexafluoride';
import './materials/Breccia';
import './materials/FerroelectricMaterial';
import './materials/Europium';
import './materials/MoltenEuropium';
import './materials/BoronTrifluoride';
import './materials/GneissGranite';
import './materials/PyroelectricMaterial';
import './materials/Cerium';
import './materials/MoltenCerium';
import './materials/CarbonTetrachloride';
import './materials/SerpentinizedPeridotite';
import './materials/ElectrothermalMaterial';

import { World } from './core/World';
import { Simulation } from './core/Simulation';
import { Renderer } from './core/Renderer';
import { InputHandler } from './ui/InputHandler';
import { Toolbar } from './ui/Toolbar';
import { InfoPanel } from './ui/InfoPanel';
import { History } from './core/History';
import { FpsGraph } from './ui/FpsGraph';
import { StatsPanel } from './ui/StatsPanel';
import { Encyclopedia } from './ui/Encyclopedia';

import { GifEncoder } from './utils/GifEncoder';

const GRID_WIDTH = 200;
const GRID_HEIGHT = 150;
const PIXEL_SCALE = 4;

const canvas = document.getElementById('canvas') as HTMLCanvasElement;
canvas.width = GRID_WIDTH * PIXEL_SCALE;
canvas.height = GRID_HEIGHT * PIXEL_SCALE;

const world = new World(GRID_WIDTH, GRID_HEIGHT);
const simulation = new Simulation(world);
const renderer = new Renderer(canvas, GRID_WIDTH, GRID_HEIGHT, PIXEL_SCALE);
const input = new InputHandler(canvas, world, PIXEL_SCALE);
const history = new History();
const infoPanel = new InfoPanel(canvas, world, PIXEL_SCALE);
const statsPanel = new StatsPanel(world);
const encyclopedia = new Encyclopedia();

let paused = false;
let simSpeed = 1; // 模拟速度倍率 1~5
let recording = false;
let gifEncoder: GifEncoder | null = null;
let recordFrameCount = 0;
const MAX_GIF_FRAMES = 150; // 最多录制 150 帧（约 5 秒）

// 时间倒流系统
const REWIND_BUFFER_SIZE = 120; // 最多记录 120 帧（约 2 秒）
const rewindBuffer: Uint16Array[] = [];
let rewindHead = 0; // 写入位置
let rewindCount = 0; // 已存帧数
let rewinding = false; // 是否正在倒流

const SAVE_KEY = 'particleworld-save';

// 绘制前保存快照（用于撤销）
input.onPaintStart = () => {
  history.pushSnapshot(world.cells);
};

// 缩放/平移回调
input.screenToGrid = (sx: number, sy: number) => renderer.screenToGrid(sx, sy);

input.onZoom = (delta: number, screenX: number, screenY: number) => {
  const oldZoom = renderer.viewZoom;
  const factor = delta > 0 ? 1.15 : 1 / 1.15;
  const newZoom = Math.max(0.25, Math.min(10, oldZoom * factor));
  // 以鼠标位置为中心缩放
  renderer.viewPanX = screenX - (screenX - renderer.viewPanX) * (newZoom / oldZoom);
  renderer.viewPanY = screenY - (screenY - renderer.viewPanY) * (newZoom / oldZoom);
  renderer.viewZoom = newZoom;
};

input.onPan = (dx: number, dy: number) => {
  renderer.viewPanX += dx;
  renderer.viewPanY += dy;
};

input.onResetView = () => {
  renderer.resetView();
};

const toolbar = new Toolbar(input, {
  onPause: () => { paused = !paused; },
  onClear: () => { world.clear(); history.clear(); },
  onSave: () => {
    localStorage.setItem(SAVE_KEY, world.save());
  },
  onLoad: () => {
    const data = localStorage.getItem(SAVE_KEY);
    if (data) world.load(data);
  },
  onUndo: () => {
    const snapshot = history.undo();
    if (snapshot) world.restoreFromSnapshot(snapshot);
  },
  onRedo: () => {
    const snapshot = history.redo();
    if (snapshot) world.restoreFromSnapshot(snapshot);
  },
  onToggleTempOverlay: () => {
    renderer.showTempOverlay = !renderer.showTempOverlay;
    toolbar.refreshTempOverlay(renderer.showTempOverlay);
  },
  onToggleGrid: () => {
    renderer.showGrid = !renderer.showGrid;
    toolbar.refreshGrid(renderer.showGrid);
  },
  onScreenshot: () => {
    const link = document.createElement('a');
    link.download = `particleworld-${Date.now()}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
  },
  onToggleMirror: () => {
    renderer.showMirrorLine = input.getMirrorMode();
  },
  onSnapshotA: () => canvas.toDataURL('image/png'),
  onSnapshotB: () => canvas.toDataURL('image/png'),
  getParticleCount: () => world.getParticleCount(),
  isPaused: () => paused,
  getSpeed: () => simSpeed,
  setSpeed: (s: number) => { simSpeed = Math.max(1, Math.min(5, s)); },
  setWind: (dir: number, strength: number) => { world.setWind(dir, strength); },
  onCycleWeather: () => {
    simulation.cycleWeather();
    return simulation.getWeatherLabel();
  },
  onToggleRecord: () => {
    if (!recording) {
      gifEncoder = new GifEncoder(GRID_WIDTH, GRID_HEIGHT, 5);
      recordFrameCount = 0;
      recording = true;
    } else {
      finishRecording();
    }
    return recording;
  },
  onExportFile: () => {
    const data = world.save();
    const blob = new Blob([data], { type: 'application/json' });
    const link = document.createElement('a');
    link.download = `particleworld-${Date.now()}.pw`;
    link.href = URL.createObjectURL(blob);
    link.click();
    URL.revokeObjectURL(link.href);
  },
  onImportFile: () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.pw,.json';
    input.addEventListener('change', () => {
      const file = input.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const text = reader.result as string;
        if (world.load(text)) {
          history.clear();
        }
      };
      reader.readAsText(file);
    });
    input.click();
  },
  onEncyclopedia: () => {
    encyclopedia.toggle();
  },
});

// 常用材质快捷键映射（数字键 1~9, 0）
const HOTKEY_MATERIALS = [1, 2, 3, 4, 6, 11, 22, 20, 5, 0]; // 沙水石木火熔岩火药泥土油橡皮

// 拖拽导入 .pw 文件
const dropOverlay = document.createElement('div');
dropOverlay.id = 'drop-overlay';
dropOverlay.style.display = 'none';
const dropHint = document.createElement('div');
dropHint.className = 'drop-hint';
dropHint.textContent = '拖放 .pw 文件以导入世界';
dropOverlay.appendChild(dropHint);
document.body.appendChild(dropOverlay);

let dragCounter = 0;
document.addEventListener('dragenter', (e) => {
  e.preventDefault();
  dragCounter++;
  dropOverlay.style.display = 'flex';
});
document.addEventListener('dragleave', (e) => {
  e.preventDefault();
  dragCounter--;
  if (dragCounter <= 0) {
    dragCounter = 0;
    dropOverlay.style.display = 'none';
  }
});
document.addEventListener('dragover', (e) => {
  e.preventDefault();
});
document.addEventListener('drop', (e) => {
  e.preventDefault();
  dragCounter = 0;
  dropOverlay.style.display = 'none';
  const file = e.dataTransfer?.files[0];
  if (!file) return;
  if (!file.name.endsWith('.pw') && !file.name.endsWith('.json')) return;
  const reader = new FileReader();
  reader.onload = () => {
    const text = reader.result as string;
    if (world.load(text)) {
      history.clear();
    }
  };
  reader.readAsText(file);
});

// 快捷键
document.addEventListener('keydown', (e) => {
  // Backspace 按住倒流
  if (e.code === 'Backspace') {
    e.preventDefault();
    if (!rewinding && rewindCount > 0) {
      rewinding = true;
    }
    return;
  }

  // Ctrl+Z 撤销 / Ctrl+Y 或 Ctrl+Shift+Z 重做
  if ((e.ctrlKey || e.metaKey) && e.code === 'KeyZ' && !e.shiftKey) {
    e.preventDefault();
    const snapshot = history.undo();
    if (snapshot) world.restoreFromSnapshot(snapshot);
    return;
  }
  if ((e.ctrlKey || e.metaKey) && (e.code === 'KeyY' || (e.code === 'KeyZ' && e.shiftKey))) {
    e.preventDefault();
    const snapshot = history.redo();
    if (snapshot) world.restoreFromSnapshot(snapshot);
    return;
  }

  // Ctrl+F 聚焦材质搜索框
  if ((e.ctrlKey || e.metaKey) && e.code === 'KeyF') {
    e.preventDefault();
    toolbar.focusSearch();
    return;
  }

  // Space 暂停
  if (e.code === 'Space') {
    e.preventDefault();
    paused = !paused;
    return;
  }

  // 数字键 1~9, 0 选材质
  if (e.code >= 'Digit1' && e.code <= 'Digit9') {
    const idx = parseInt(e.code.charAt(5)) - 1;
    if (idx < HOTKEY_MATERIALS.length) {
      input.setMaterial(HOTKEY_MATERIALS[idx]);
      toolbar.refreshMaterialSelection();
    }
    return;
  }
  if (e.code === 'Digit0') {
    input.setMaterial(HOTKEY_MATERIALS[9]);
    toolbar.refreshMaterialSelection();
    return;
  }

  // [ ] 调笔刷大小
  if (e.code === 'BracketLeft') {
    input.setBrushSize(input.getBrushSize() - 1);
    toolbar.refreshBrushSize();
    return;
  }
  if (e.code === 'BracketRight') {
    input.setBrushSize(input.getBrushSize() + 1);
    toolbar.refreshBrushSize();
    return;
  }

  // - = 调速度
  if (e.code === 'Minus') {
    simSpeed = Math.max(1, simSpeed - 1);
    toolbar.refreshSpeed(simSpeed);
    return;
  }
  if (e.code === 'Equal') {
    simSpeed = Math.min(5, simSpeed + 1);
    toolbar.refreshSpeed(simSpeed);
    return;
  }

  // T 键切换温度可视化
  if (e.code === 'KeyT') {
    renderer.showTempOverlay = !renderer.showTempOverlay;
    toolbar.refreshTempOverlay(renderer.showTempOverlay);
    return;
  }

  // G 键切换网格线
  if (e.code === 'KeyG') {
    renderer.showGrid = !renderer.showGrid;
    toolbar.refreshGrid(renderer.showGrid);
    return;
  }

  // B 键切换笔刷形状
  if (e.code === 'KeyB') {
    const shapes = ['circle', 'square', 'line', 'spray'] as const;
    const current = input.getBrushShape();
    const idx = shapes.indexOf(current);
    const next = shapes[(idx + 1) % shapes.length];
    input.setBrushShape(next);
    toolbar.refreshBrushShape();
    return;
  }

  // E 键切换橡皮擦
  if (e.code === 'KeyE') {
    if (input.getMaterial() === 0) {
      input.setMaterial(1); // 切回沙子
    } else {
      input.setMaterial(0);
    }
    toolbar.refreshMaterialSelection();
    return;
  }

  // F 键切换填充模式
  if (e.code === 'KeyF') {
    const current = input.getDrawMode();
    input.setDrawMode(current === 'fill' ? 'brush' : 'fill');
    toolbar.refreshDrawMode();
    return;
  }

  // X 键切换替换模式
  if (e.code === 'KeyX') {
    const current = input.getDrawMode();
    input.setDrawMode(current === 'replace' ? 'brush' : 'replace');
    toolbar.refreshDrawMode();
    return;
  }

  // R 键切换随机材质模式
  if (e.code === 'KeyR') {
    input.setRandomMode(!input.getRandomMode());
    toolbar.refreshRandomMode();
    return;
  }

  // Q 键顺时针旋转世界 90°
  if (e.code === 'KeyQ') {
    world.rotateCW();
    return;
  }

  // W 键循环切换天气
  if (e.code === 'KeyW') {
    const label = simulation.cycleWeather();
    toolbar.refreshWeather(label);
    return;
  }

  // S 键切换材质统计面板
  if (e.code === 'KeyS') {
    statsPanel.toggle();
    return;
  }

  // H 键打开材质百科全书
  if (e.code === 'KeyH') {
    encyclopedia.toggle();
    return;
  }

  // M 键切换镜像绘制模式
  if (e.code === 'KeyM') {
    input.setMirrorMode(!input.getMirrorMode());
    renderer.showMirrorLine = input.getMirrorMode();
    toolbar.refreshMirrorMode();
    return;
  }

  // D 键循环喷雾密度 (20% → 40% → 60% → 80% → 100% → 20%)
  if (e.code === 'KeyD') {
    const current = Math.round(input.getSprayDensity() * 100);
    const steps = [20, 40, 60, 80, 100];
    const idx = steps.indexOf(current);
    const next = steps[(idx + 1) % steps.length];
    input.setSprayDensity(next / 100);
    toolbar.refreshSprayDensity();
    return;
  }

  // G 键切换渐变笔刷
  if (e.code === 'KeyG') {
    input.setGradientBrush(!input.getGradientBrush());
    toolbar.refreshGradientBrush();
    return;
  }

  // Shift+Arrow 翻转世界
  if (e.shiftKey && e.code === 'ArrowUp') {
    e.preventDefault();
    world.flipVertical();
    return;
  }
  if (e.shiftKey && e.code === 'ArrowDown') {
    e.preventDefault();
    world.flipVertical();
    return;
  }
  if (e.shiftKey && e.code === 'ArrowLeft') {
    e.preventDefault();
    world.flipHorizontal();
    return;
  }
  if (e.shiftKey && e.code === 'ArrowRight') {
    e.preventDefault();
    world.flipHorizontal();
    return;
  }

  // Home 键重置视图缩放/平移
  if (e.code === 'Home') {
    renderer.resetView();
    return;
  }

  // P 键截图
  if (e.code === 'KeyP') {
    const link = document.createElement('a');
    link.download = `particleworld-${Date.now()}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
    return;
  }
});

document.addEventListener('keyup', (e) => {
  if (e.code === 'Backspace') {
    rewinding = false;
  }
});

// 小地图点击拦截（capture 阶段优先处理）
canvas.addEventListener('mousedown', (e) => {
  const rect = canvas.getBoundingClientRect();
  if (renderer.minimapClick(e.clientX - rect.left, e.clientY - rect.top)) {
    e.stopPropagation();
  }
}, true);

// 录制完成：编码并下载 GIF
function finishRecording(): void {
  if (gifEncoder) {
    const blob = gifEncoder.encode();
    const link = document.createElement('a');
    link.download = `particleworld-${Date.now()}.gif`;
    link.href = URL.createObjectURL(blob);
    link.click();
    URL.revokeObjectURL(link.href);
    gifEncoder = null;
  }
  recording = false;
  recordFrameCount = 0;
  toolbar.refreshRecord(false);
}

// GIF 录制用的缩小 canvas（原始分辨率，不含 UI）
const gifCanvas = document.createElement('canvas');
gifCanvas.width = GRID_WIDTH;
gifCanvas.height = GRID_HEIGHT;
const gifCtx = gifCanvas.getContext('2d')!;

// FPS 图表
const fpsGraph = new FpsGraph();

function loop() {
  if (rewinding) {
    // 倒流模式：从缓冲区回放
    if (rewindCount > 0) {
      rewindHead = (rewindHead - 1 + REWIND_BUFFER_SIZE) % REWIND_BUFFER_SIZE;
      rewindCount--;
      world.restoreFromSnapshot(rewindBuffer[rewindHead]);
    }
  } else if (!paused) {
    // 正常模拟：记录帧到环形缓冲区
    for (let i = 0; i < simSpeed; i++) {
      // 每步模拟前记录快照
      if (!rewindBuffer[rewindHead]) {
        rewindBuffer[rewindHead] = new Uint16Array(world.cells.length);
      }
      rewindBuffer[rewindHead].set(world.cells);
      rewindHead = (rewindHead + 1) % REWIND_BUFFER_SIZE;
      if (rewindCount < REWIND_BUFFER_SIZE) rewindCount++;

      simulation.update();
    }
  }
  renderer.render(world);

  // GIF 录制：每 3 帧捕获一次（降低文件大小）
  if (recording && gifEncoder && !paused) {
    if (recordFrameCount % 3 === 0) {
      gifCtx.drawImage(canvas, 0, 0, GRID_WIDTH, GRID_HEIGHT);
      gifEncoder.addFrame(gifCanvas);
    }
    recordFrameCount++;
    if (recordFrameCount >= MAX_GIF_FRAMES) {
      finishRecording();
    }
  }

  // 笔刷预览
  if (input.cursorVisible) {
    renderer.renderBrushPreview(input.cursorX, input.cursorY, input.getBrushSize(), input.getBrushShape(), input.getGradientBrush(), input.getBrushAngle());
    // 线条模式预览
    if (input.isDrawingLine()) {
      const [lx, ly] = input.getLineStart();
      renderer.renderLinePreview(lx, ly, input.cursorX, input.cursorY);
    }
  }

  toolbar.updateStats();
  infoPanel.update();
  statsPanel.update();
  fpsGraph.tick();

  requestAnimationFrame(loop);
}

requestAnimationFrame(loop);
