// 注册所有材质（副作用导入）
import './materials/Empty';
import './materials/Sand';
import './materials/Water';
import './materials/Stone';
import './materials/Wood';
import './materials/Oil';
import './materials/Fire';
import './materials/Smoke';
import './materials/Steam';
import './materials/Acid';
import './materials/Metal';
import './materials/Lava';
import './materials/Seed';
import './materials/Plant';
import './materials/Ice';
import './materials/Snow';
import './materials/Lightning';
import './materials/Glass';
import './materials/Poison';
import './materials/Hydrogen';
import './materials/Dirt';
import './materials/Clay';
import './materials/Gunpowder';
import './materials/Salt';
import './materials/Saltwater';
import './materials/Wax';
import './materials/MoltenWax';
import './materials/Firework';
import './materials/Spark';
import './materials/Putty';
import './materials/Philosopher';
import './materials/Gold';
import './materials/Diamond';
import './materials/Rubber';
import './materials/Cement';
import './materials/Clone';
import './materials/Void';
import './materials/Fountain';
import './materials/Ant';
import './materials/Portal';
import './materials/Magnet';
import './materials/Virus';
import './materials/Wire';
import './materials/Honey';
import './materials/Charcoal';
import './materials/Laser';
import './materials/Moss';
import './materials/Tornado';
import './materials/Foam';
import './materials/Firefly';
import './materials/Crystal';
import './materials/Swamp';
import './materials/Plasma';
import './materials/Mercury';
import './materials/Vine';
import './materials/Meteor';
import './materials/Cobweb';
import './materials/Obsidian';
import './materials/Amber';
import './materials/Phosphorus';
import './materials/Mud';
import './materials/Coral';
import './materials/DryIce';
import './materials/Sulfur';
import './materials/Tar';
import './materials/LiquidNitrogen';
import './materials/Fluorite';
import './materials/Mycelium';
import './materials/Resin';
import './materials/Rust';
import './materials/Bubble';
import './materials/OilSand';
import './materials/Frost';
import './materials/Cloud';
import './materials/Basalt';
import './materials/Tundra';
import './materials/Sodium';
import './materials/GlowLiquid';
import './materials/Termite';
import './materials/Gel';
import './materials/MoltenSalt';
import './materials/Sandstorm';
import './materials/Copper';
import './materials/Tin';
import './materials/Blood';
import './materials/Gear';
import './materials/Slime';
import './materials/Ceramic';
import './materials/Fiber';
import './materials/MoltenGlass';
import './materials/Spore';
import './materials/Thermite';
import './materials/Methane';
import './materials/Ferrofluid';
import './materials/DistilledWater';
import './materials/Quartz';
import './materials/Soda';
import './materials/Mushroom';
import './materials/Snowball';
import './materials/SteamEngine';
import './materials/GoldDust';
import './materials/RainbowLiquid';
import './materials/Bone';
import './materials/Brick';
import './materials/Honeycomb';
import './materials/LiquidHelium';
import './materials/Nitroglycerin';
import './materials/MossyStone';
import './materials/BallLightning';
import './materials/RockSalt';
import './materials/MoltenMetal';
import './materials/Pollen';
import './materials/Pumice';
import './materials/Zeolite';
import './materials/LiquidCrystal';
import './materials/Dolomite';
import './materials/Rocket';
import './materials/DesertRose';
import './materials/Static';
import './materials/OilShale';
import './materials/SteamCloud';
import './materials/Quicklime';
import './materials/Foxfire';
import './materials/Nacre';
import './materials/Diatomite';
import './materials/PlasmaOrb';
import './materials/Coke';
import './materials/Dew';
import './materials/IndustrialMoltenSalt';
import './materials/Aerogel';
import './materials/Phosphor';
import './materials/Hay';
import './materials/LiquidSulfur';
import './materials/SiliconCarbide';
import './materials/Tide';
import './materials/Sphalerite';
import './materials/LiquidOxygen';
import './materials/GlowAlgae';
import './materials/Graphite';
import './materials/Peat';
import './materials/SilicaGel';
import './materials/VolcanicAsh';
import './materials/Arc';
import './materials/DrySand';
import './materials/MagneticSand';
import './materials/MoltenCopper';
import './materials/Muscovite';
import './materials/Niter';
import './materials/Asbestos';
import './materials/CarbonFiber';
import './materials/MoltenAluminum';
import './materials/GlowStick';
import './materials/BlackPowder';
import './materials/Seaweed';
import './materials/MoltenQuartz';
import './materials/Potassium';
import './materials/PhosphoricAcid';
import './materials/Opal';
import './materials/Luminol';
import './materials/DriedVine';
import './materials/SulfuricAcid';
import './materials/Zircon';
import './materials/SteamBubble';
import './materials/Antimony';
import './materials/MoltenAntimony';
import './materials/IceCrystal';
import './materials/MudBrick';
import './materials/FireworkShell';
import './materials/Alcohol';
import './materials/Lye';
import './materials/Gypsum';
import './materials/MoltenIron';
import './materials/FulguriteSand';
import './materials/WhiteTin';
import './materials/MoltenSodium';
import './materials/Limewater';
import './materials/AsphaltLake';
import './materials/Phosphine';
import './materials/Bismuth';
import './materials/MoltenBismuth';
import './materials/NitricAcid';
import './materials/QuartzSand';
import './materials/Magnesium';
import './materials/FlashPowder';
import './materials/Amalgam';
import './materials/Silicon';
import './materials/MoltenSilicon';
import './materials/Permafrost';
import './materials/HydrogenPeroxide';
import './materials/Titanium';
import './materials/MoltenTitanium';
import './materials/PhosphorusFire';
import './materials/Limestone';
import './materials/Alum';
import './materials/Glycerin';
import './materials/CryoFluid';
import './materials/Tungsten';
import './materials/MoltenTungsten';
import './materials/Borax';
import './materials/ElectroPlasma';
import './materials/PeatMoss';
import './materials/LavaRock';
import './materials/Jellyfish';
import './materials/Chromium';
import './materials/MoltenChromium';
import './materials/HydrogenFluoride';
import './materials/Graphene';
import './materials/GlassBead';
import './materials/Manganese';
import './materials/MoltenManganese';
import './materials/SodiumCyanide';
import './materials/Calcite';
import './materials/Thermoplastic';
import './materials/Nickel';
import './materials/MoltenNickel';
import './materials/Formaldehyde';
import './materials/Drywall';
import './materials/ThermalPaste';
import './materials/Zinc';
import './materials/MoltenZinc';
import './materials/Ammonia';
import './materials/DiatomMud';
import './materials/GlowMoss';
import './materials/Lead';
import './materials/MoltenLead';
import './materials/Ozone';
import './materials/VolcanicGlass';
import './materials/Electromagnet';
import './materials/Cobalt';
import './materials/MoltenCobalt';
import './materials/CarbonMonoxide';
import './materials/Slate';
import './materials/PiezoelectricCeramic';
import './materials/TinBronze';
import './materials/MoltenTinBronze';
import './materials/Chlorine';
import './materials/Marble';
import './materials/OpticalFiber';
import './materials/Vanadium';
import './materials/MoltenVanadium';
import './materials/SulfurDioxide';
import './materials/Sandstone';
import './materials/CarbonNanotube';
import './materials/Silver';
import './materials/MoltenSilver';
import './materials/NitrousOxide';
import './materials/Granite';
import './materials/Superconductor';
import './materials/Platinum';
import './materials/MoltenPlatinum';
import './materials/Phosgene';
import './materials/Flint';
import './materials/Nanobot';
import './materials/Molybdenum';
import './materials/MoltenMolybdenum';
import './materials/Argon';
import './materials/Shale';
import './materials/ShapeMemoryAlloy';
import './materials/Hafnium';
import './materials/MoltenHafnium';
import './materials/Xenon';
import './materials/Gneiss';
import './materials/ShapeMemoryPolymer';
import './materials/Iridium';
import './materials/MoltenIridium';
import './materials/Neon';
import './materials/Serpentinite';
import './materials/PiezoFilm';
import './materials/Rhodium';
import './materials/MoltenRhodium';
import './materials/Radon';
import './materials/Diabase';
import './materials/ShapeMemoryCeramic';
import './materials/Niobium';
import './materials/MoltenNiobium';
import './materials/Fluorine';
import './materials/Amphibolite';
import './materials/ConductivePolymer';
import './materials/Palladium';
import './materials/MoltenPalladium';
import './materials/Helium';
import './materials/Schist';
import './materials/Electrochromic';
import './materials/Zirconium';
import './materials/MoltenZirconium';
import './materials/Bromine';
import './materials/Quartzite';
import './materials/Thermoelectric';
import './materials/HafniumAlloy';
import './materials/MoltenHafniumAlloy';
import './materials/Krypton';
import './materials/Hornfels';
import './materials/SelfHealingMaterial';

import { World } from './core/World';
import { Simulation } from './core/Simulation';
import { Renderer } from './core/Renderer';
import { InputHandler } from './ui/InputHandler';
import { Toolbar } from './ui/Toolbar';
import { InfoPanel } from './ui/InfoPanel';
import { History } from './core/History';
import { FpsGraph } from './ui/FpsGraph';
import { StatsPanel } from './ui/StatsPanel';

const GRID_WIDTH = 200;
const GRID_HEIGHT = 150;
const PIXEL_SCALE = 4;

const canvas = document.getElementById('canvas') as HTMLCanvasElement;
canvas.width = GRID_WIDTH * PIXEL_SCALE;
canvas.height = GRID_HEIGHT * PIXEL_SCALE;

const world = new World(GRID_WIDTH, GRID_HEIGHT);
const simulation = new Simulation(world);
const renderer = new Renderer(canvas, GRID_WIDTH, GRID_HEIGHT, PIXEL_SCALE);
const input = new InputHandler(canvas, world, PIXEL_SCALE);
const history = new History();
const infoPanel = new InfoPanel(canvas, world, PIXEL_SCALE);
const statsPanel = new StatsPanel(world);

let paused = false;
let simSpeed = 1; // 模拟速度倍率 1~5

const SAVE_KEY = 'particleworld-save';

// 绘制前保存快照（用于撤销）
input.onPaintStart = () => {
  history.pushSnapshot(world.cells);
};

const toolbar = new Toolbar(input, {
  onPause: () => { paused = !paused; },
  onClear: () => { world.clear(); history.clear(); },
  onSave: () => {
    localStorage.setItem(SAVE_KEY, world.save());
  },
  onLoad: () => {
    const data = localStorage.getItem(SAVE_KEY);
    if (data) world.load(data);
  },
  onUndo: () => {
    const snapshot = history.undo();
    if (snapshot) world.restoreFromSnapshot(snapshot);
  },
  onRedo: () => {
    const snapshot = history.redo();
    if (snapshot) world.restoreFromSnapshot(snapshot);
  },
  onToggleTempOverlay: () => {
    renderer.showTempOverlay = !renderer.showTempOverlay;
    toolbar.refreshTempOverlay(renderer.showTempOverlay);
  },
  onToggleGrid: () => {
    renderer.showGrid = !renderer.showGrid;
    toolbar.refreshGrid(renderer.showGrid);
  },
  onScreenshot: () => {
    const link = document.createElement('a');
    link.download = `particleworld-${Date.now()}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
  },
  getParticleCount: () => world.getParticleCount(),
  isPaused: () => paused,
  getSpeed: () => simSpeed,
  setSpeed: (s: number) => { simSpeed = Math.max(1, Math.min(5, s)); },
  setWind: (dir: number, strength: number) => { world.setWind(dir, strength); },
});

// 常用材质快捷键映射（数字键 1~9, 0）
const HOTKEY_MATERIALS = [1, 2, 3, 4, 6, 11, 22, 20, 5, 0]; // 沙水石木火熔岩火药泥土油橡皮

// 快捷键
document.addEventListener('keydown', (e) => {
  // Ctrl+Z 撤销 / Ctrl+Y 或 Ctrl+Shift+Z 重做
  if ((e.ctrlKey || e.metaKey) && e.code === 'KeyZ' && !e.shiftKey) {
    e.preventDefault();
    const snapshot = history.undo();
    if (snapshot) world.restoreFromSnapshot(snapshot);
    return;
  }
  if ((e.ctrlKey || e.metaKey) && (e.code === 'KeyY' || (e.code === 'KeyZ' && e.shiftKey))) {
    e.preventDefault();
    const snapshot = history.redo();
    if (snapshot) world.restoreFromSnapshot(snapshot);
    return;
  }

  // Space 暂停
  if (e.code === 'Space') {
    e.preventDefault();
    paused = !paused;
    return;
  }

  // 数字键 1~9, 0 选材质
  if (e.code >= 'Digit1' && e.code <= 'Digit9') {
    const idx = parseInt(e.code.charAt(5)) - 1;
    if (idx < HOTKEY_MATERIALS.length) {
      input.setMaterial(HOTKEY_MATERIALS[idx]);
      toolbar.refreshMaterialSelection();
    }
    return;
  }
  if (e.code === 'Digit0') {
    input.setMaterial(HOTKEY_MATERIALS[9]);
    toolbar.refreshMaterialSelection();
    return;
  }

  // [ ] 调笔刷大小
  if (e.code === 'BracketLeft') {
    input.setBrushSize(input.getBrushSize() - 1);
    toolbar.refreshBrushSize();
    return;
  }
  if (e.code === 'BracketRight') {
    input.setBrushSize(input.getBrushSize() + 1);
    toolbar.refreshBrushSize();
    return;
  }

  // - = 调速度
  if (e.code === 'Minus') {
    simSpeed = Math.max(1, simSpeed - 1);
    toolbar.refreshSpeed(simSpeed);
    return;
  }
  if (e.code === 'Equal') {
    simSpeed = Math.min(5, simSpeed + 1);
    toolbar.refreshSpeed(simSpeed);
    return;
  }

  // T 键切换温度可视化
  if (e.code === 'KeyT') {
    renderer.showTempOverlay = !renderer.showTempOverlay;
    toolbar.refreshTempOverlay(renderer.showTempOverlay);
    return;
  }

  // G 键切换网格线
  if (e.code === 'KeyG') {
    renderer.showGrid = !renderer.showGrid;
    toolbar.refreshGrid(renderer.showGrid);
    return;
  }

  // B 键切换笔刷形状
  if (e.code === 'KeyB') {
    const shapes = ['circle', 'square', 'line'] as const;
    const current = input.getBrushShape();
    const idx = shapes.indexOf(current);
    const next = shapes[(idx + 1) % shapes.length];
    input.setBrushShape(next);
    toolbar.refreshBrushShape();
    return;
  }

  // E 键切换橡皮擦
  if (e.code === 'KeyE') {
    if (input.getMaterial() === 0) {
      input.setMaterial(1); // 切回沙子
    } else {
      input.setMaterial(0);
    }
    toolbar.refreshMaterialSelection();
    return;
  }

  // F 键切换填充模式
  if (e.code === 'KeyF') {
    const current = input.getDrawMode();
    input.setDrawMode(current === 'fill' ? 'brush' : 'fill');
    toolbar.refreshDrawMode();
    return;
  }

  // R 键切换随机材质模式
  if (e.code === 'KeyR') {
    input.setRandomMode(!input.getRandomMode());
    toolbar.refreshRandomMode();
    return;
  }

  // S 键切换材质统计面板
  if (e.code === 'KeyS') {
    statsPanel.toggle();
    return;
  }

  // P 键截图
  if (e.code === 'KeyP') {
    const link = document.createElement('a');
    link.download = `particleworld-${Date.now()}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
    return;
  }
});

// FPS 图表
const fpsGraph = new FpsGraph();

function loop() {
  if (!paused) {
    for (let i = 0; i < simSpeed; i++) {
      simulation.update();
    }
  }
  renderer.render(world);

  // 笔刷预览
  if (input.cursorVisible) {
    renderer.renderBrushPreview(input.cursorX, input.cursorY, input.getBrushSize(), input.getBrushShape());
    // 线条模式预览
    if (input.isDrawingLine()) {
      const [lx, ly] = input.getLineStart();
      renderer.renderLinePreview(lx, ly, input.cursorX, input.cursorY);
    }
  }

  toolbar.updateStats();
  infoPanel.update();
  statsPanel.update();
  fpsGraph.tick();

  requestAnimationFrame(loop);
}

requestAnimationFrame(loop);
