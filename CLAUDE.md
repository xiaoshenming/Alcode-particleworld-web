# Particle World - 粉末沙盒模拟游戏

## 核心目标
创建一个基于物理引擎的粉末沙盒模拟游戏，运行在浏览器中。

## 本质需求
- 模拟物质世界的物理行为（重力、流动、燃烧、反应等）
- 用户可以与模拟世界交互（添加/删除/修改物质）
- 不同材质之间有真实的相互作用
- 视觉上有清晰的材质区分和动态效果

## 技术架构

### 技术栈
- TypeScript + Vite（零运行时依赖）
- Canvas 2D 渲染，像素风格（imageSmoothingEnabled = false）

### 核心数据结构
- `World`: 200x150 网格，TypedArray 存储
  - `cells: Uint16Array` — 材质 ID（支持 65535 种）
  - `colors: Uint32Array` — ABGR 颜色（直接写入 ImageData）
  - `_updated: Uint8Array` — 帧内更新标记
  - `_awake / _awakeNext: Uint8Array` — 双缓冲活跃标记
  - `age: Uint16Array` — 粒子年龄（每帧递增，最大65535）
- `Simulation`: 从底向上扫描，随机左右方向，只处理活跃粒子
- `Renderer`: 1:1 ImageData → 临时 Canvas → 4x 缩放绘制到主 Canvas

### 材质系统
- `MaterialDef` 接口：id, name, color(), density, update()
- `registry.ts` 注册表：Map<id, MaterialDef>
- 材质 ID 分配：0=空气, 1=沙子, 2=水, 3=石头, 4=木头, 5=油, 6=火, 7=烟, 8=蒸汽, 9=酸液, 10=金属, 11=熔岩, 12=种子, 13=植物, 14=冰, 15=雪, 16=雷电, 17=玻璃, 18=毒气, 19=氢气, 20=泥土, 21=黏土, 22=火药, 23=盐, 24=盐水, 25=蜡, 26=液蜡, 27=烟花, 28=火花, 29=橡皮泥, 30=炼金石, 31=金, 32=钻石, 33=橡胶, 34=水泥, 35=湿水泥, 36=混凝土, 37=克隆体, 38=虚空, 39=喷泉, 40=蚂蚁, 41=传送门, 42=磁铁, 43=病毒, 44=电线, 45=蜂蜜, 46=木炭, 47=激光, 48=光束, 49=苔藓, 50=龙卷风, 51=泡沫, 52=萤火虫, 53=水晶, 54=沼泽, 55=等离子体, 56=水银, 57=藤蔓, 58=陨石, 59=蛛丝, 60=黑曜石, 61=琥珀, 62=白磷, 63=泥浆, 64=珊瑚, 65=干冰, 66=硫磺, 67=沥青, 68=液氮, 69=萤石, 70=菌丝, 71=树脂, 72=铁锈, 73=泡泡, 74=焦油砂, 75=霜, 76=云, 77=岩浆岩, 78=苔原, 79=钠, 80=荧光液, 81=白蚁, 82=凝胶, 83=熔盐, 84=沙尘暴, 85=铜, 86=锡, 87=血液, 88=齿轮, 89=黏液, 90=陶瓷, 91=纤维, 92=液态玻璃, 93=孢子, 94=铝热剂, 95=沼气, 96=磁流体, 97=蒸馏水, 98=石英, 99=苏打, 100=蘑菇, 101=雪球, 102=蒸汽机, 103=沙金, 104=彩虹液, 105=骨头, 106=粘土砖, 107=蜂巢, 108=液态氦, 109=硝化甘油, 110=苔藓石, 111=闪电球, 112=岩盐, 113=液态金属, 114=花粉, 115=浮石, 116=沸石, 117=液晶, 118=白云石, 119=焰火弹, 120=沙漠玫瑰, 121=静电, 122=油页岩, 123=蒸汽云, 124=石灰, 125=磷火, 126=珍珠母, 127=硅藻土, 128=等离子球, 129=焦炭, 130=露水, 131=工业熔盐, 132=气凝胶, 133=荧光粉, 134=干草, 135=液态硫
- 136=碳化硅, 137=潮汐, 138=闪锌矿, 139=液态氧, 140=荧光藻, 141=石墨, 142=泥炭, 143=硅胶, 144=火山灰, 145=电弧, 146=干沙, 147=磁沙, 148=液态铜, 149=白云母, 150=硝石, 151=石棉, 152=碳纤维, 153=液态铝, 154=荧光棒, 155=黑火药, 156=水草, 157=熔融石英, 158=钾, 159=磷酸, 160=蛋白石
- 161=锑, 162=液态锑, 163=冰晶, 164=泥砖, 165=焰火弹壳, 166=酒精, 167=碱液, 168=石膏, 169=液态铁, 170=闪电熔沙, 171=鲁米诺, 172=干藤, 173=硫酸, 174=锆石, 175=蒸汽泡
- 176=白锡, 177=液态钠, 178=石灰水, 179=沥青湖, 180=磷化氢, 181=铋, 182=液态铋, 183=硝酸, 184=石英砂, 185=镁, 186=闪光粉, 187=汞齐, 188=硅, 189=液态硅, 190=永冻土
- 191=过氧化氢, 192=钛, 193=液态钛, 194=白磷火, 195=石灰石, 196=明矾, 197=甘油, 198=超冷液, 199=钨, 200=液态钨, 201=硼砂, 202=电浆, 203=泥炭苔, 204=熔岩石, 205=荧光水母
- 206=铬, 207=液态铬, 208=氟化氢, 209=石墨烯, 210=玻璃珠, 211=锰, 212=液态锰, 213=氰化钠, 214=方解石, 215=热塑性塑料
- 216=镍, 217=液态镍, 218=甲醛, 219=石膏板, 220=导热膏, 221=锌, 222=液态锌, 223=氨气, 224=硅藻泥, 225=发光苔藓
- 226=铅, 227=液态铅, 228=臭氧, 229=火山玻璃, 230=电磁铁
- 231=钴, 232=液态钴, 233=一氧化碳, 234=板岩, 235=压电陶瓷
- 236=锡青铜, 237=液态锡青铜, 238=氯气, 239=大理石, 240=光纤
- 241=钒, 242=液态钒, 243=二氧化硫, 244=砂岩, 245=碳纳米管
- 246=银, 247=液态银, 248=笑气, 249=花岗岩, 250=超导体
- 251=铂, 252=液态铂, 253=光气, 254=燧石, 255=纳米机器人
- 256=钼, 257=液态钼, 258=氩气, 259=页岩, 260=记忆合金
- 261=铪, 262=液态铪, 263=氙气, 264=片麻岩, 265=记忆聚合物
- 266=铱, 267=液态铱, 268=氖气, 269=蛇纹岩, 270=压电薄膜
- 271=铑, 272=液态铑, 273=氡气, 274=辉绿岩, 275=形状记忆陶瓷
- 276=铌, 277=液态铌, 278=氟气, 279=角闪岩, 280=导电聚合物
- 281=钯, 282=液态钯, 283=氦气, 284=片岩, 285=电致变色材料
- 286=锆, 287=液态锆, 288=溴气, 289=石英岩, 290=热电材料
- 291=铪合金, 292=液态铪合金, 293=氪气, 294=角岩, 295=自修复材料
- 296=钽, 297=液态钽, 298=氘气, 299=辉长岩, 300=忆阻器
- 301=铼合金, 302=液态铼合金, 303=三氟化氮, 304=安山岩, 305=光致变色材料
- 306=铊, 307=液态铊, 308=碘气, 309=麻粒岩, 310=光伏材料
- 311=锇, 312=液态锇, 313=砷化氢, 314=榴辉岩, 315=柔性电路
- 316=铟, 317=液态铟, 318=硫化氢, 319=矽卡岩, 320=柔性显示材料
- 321=锗, 322=液态锗, 323=溴化氢, 324=辉石岩, 325=柔性太阳能
- 326=铌铁合金, 327=液态铌铁, 328=甲硅烷, 329=变质辉绿岩, 330=热致变色材料
- 331=镝, 332=液态镝, 333=四氟化硅, 334=蓝片岩, 335=量子点材料
- 336=铪铽合金, 337=液态铪铽, 338=硒化氢, 339=云母片岩, 340=电致发光材料
- 341=铽, 342=液态铽, 343=三氯化磷, 344=叶岩, 345=磁致伸缩材料
- 346=钐, 347=液态钐, 348=六氟化硫, 349=角砾岩, 350=铁电材料
- 351=铕, 352=液态铕, 353=三氟化硼, 354=片麻花岗岩, 355=热释电材料
- 356=铈, 357=液态铈, 358=四氯化碳, 359=蛇纹石化橄榄岩, 360=电热材料
- 361=镨, 362=液态镨, 363=五氟化磷, 364=绿片岩, 365=光热材料
- 366=镧, 367=液态镧, 368=三氟化砷, 369=叶蜡石, 370=声致发光材料
- 371=钕, 372=液态钕, 373=六氟化钨, 374=角闪石, 375=磁光材料
- 376=钆, 377=液态钆, 378=三氯化硼, 379=千枚岩, 380=磁阻材料
- 381=镱, 382=液态镱, 383=四氟化锗, 384=蛇纹岩化橄榄岩, 385=电流变液
- 386=钬, 387=液态钬, 388=五氯化磷, 389=绢云母岩, 390=介电弹性体
- 391=铥, 392=液态铥, 393=六氟化硒, 394=云母岩, 395=光弹性材料
- 396=铒, 397=液态铒, 398=三氟化氯, 399=角页岩, 400=光声材料
- 401=镥, 402=液态镥, 403=五氟化氯, 404=蛇纹岩(404), 405=声光材料
- 406=钌, 407=液态钌, 408=四氟化碳, 409=皂石, 410=声电材料
- 411=铪铼合金, 412=液态铪铼, 413=二氟化氙, 414=伟晶岩, 415=磁弹性材料
- 416=钍, 417=液态钍, 418=三氟化铁, 419=辉钼矿, 420=电磁弹性材料
- 421=铍, 422=液态铍, 423=氟化铵, 424=正长岩, 425=光磁材料
- 426=镓, 427=液态镓, 428=氟化钙, 429=拉长岩, 430=热磁材料
- 431=铟, 432=液态铟, 433=氟化铝, 434=辉石岩, 435=光电材料
- 436=铯, 437=液态铯, 438=氟化钡, 439=辉绿岩, 440=声磁材料
- 441=钇, 442=液态钇, 443=氟化锂, 444=蛇纹石化辉长岩, 445=声弹性材料
- 446=铪钨合金, 447=液态铪钨, 448=氟化镁, 449=混合片麻岩, 450=热声材料
- 451=钪, 452=液态钪, 453=氟化钠, 454=角闪片岩, 455=磁声材料
- 456=钛铌合金, 457=液态钛铌, 458=氟化钾, 459=绿泥片岩, 460=电声材料
- 461=铌钽合金, 462=液态铌钽, 463=氟化钙钠, 464=绿帘石岩, 465=光声电材料
- 466=铌锆合金, 467=液态铌锆, 468=氟化铷, 469=绿色片岩, 470=磁电声材料
- 471=铌铪合金, 472=液态铌铪, 473=氟化铯, 474=绿泥岩, 475=声电光材料
- 476=铌钼合金, 477=液态铌钼, 478=氟化铊, 479=绿帘片岩, 480=电光声材料
- 481=铌铼合金, 482=液态铌铼, 483=氟化铟, 484=绿纤石岩, 485=光电声材料
- 486=铌铬合金, 487=液态铌铬, 488=氟化镓, 489=绿柱石岩, 490=声光电材料
- 491=铌钒合金, 492=液态铌钒, 493=氟化锗, 494=蛇绿岩, 495=热光声材料
- 496=铌钛合金, 497=液态铌钛, 498=氟化铍, 499=角闪片麻岩, 500=磁热光材料
- 501=铌钨合金, 502=液态铌钨, 503=氟化锶, 504=蓝闪片岩, 505=热磁光材料
- 506=铌钴合金, 507=液态铌钴, 508=氟化钡钠, 509=辉石片岩, 510=光磁热材料
- 511=铌镍合金, 512=液态铌镍, 513=氟化锆, 514=橄榄片岩, 515=声热磁材料
- 516=铌锌合金, 517=液态铌锌, 518=氟化铪, 519=石榴片岩, 520=电磁热材料
- 521=铌铝合金, 522=液态铌铝, 523=氟化钍, 524=堇青片岩, 525=磁声热材料
- 526=铌铜合金, 527=液态铌铜, 528=氟化铈, 529=十字石片岩, 530=热声电材料
- 531=铌锰合金, 532=液态铌锰, 533=氟化钇, 534=硅线石片岩, 535=磁热声材料
- 536=铌银合金, 537=液态铌银, 538=氟化镧, 539=蓝晶石片岩, 540=电热声材料
- 541=铌金合金, 542=液态铌金, 543=氟化钕, 544=红柱石片岩, 545=光热声材料
- 546=铌铂合金, 547=液态铌铂, 548=氟化钆, 549=硅灰石片岩, 550=磁光声材料
- 551=铌铱合金, 552=液态铌铱, 553=氟化镝, 554=透辉石片岩, 555=电光声材料
- 556=铌铑合金, 557=液态铌铑, 558=氟化铕, 559=阳起石片岩, 560=磁电光材料
- 561=铌钯合金, 562=液态铌钯, 563=氟化铽, 564=透闪石片岩, 565=热光电材料
- 566=铌锇合金, 567=液态铌锇, 568=氟化钐, 569=滑石片岩, 570=声磁电材料
- 571=铌钌合金, 572=液态铌钌, 573=氟化钬, 574=绿泥石片岩, 575=光磁电材料
- 576=铌钪合金, 577=液态铌钪, 578=氟化铒, 579=蛇纹石片岩, 580=热磁电材料
- 581=铌钇合金, 582=液态铌钇, 583=氟化镥, 584=正长片岩, 585=电热磁材料
- 586=铌铈合金, 587=液态铌铈, 588=氟化钪, 589=皂石片岩, 590=光电磁材料
- 591=铌镧合金, 592=液态铌镧, 593=氟化镨, 594=辉石片麻岩, 595=声热电材料
- 596=铌铍合金, 597=液态铌铍, 598=氟化铥, 599=拉长片岩, 600=磁热电材料
- 601=铌镝合金, 602=液态铌镝, 603=氟化镱, 604=辉绿片岩, 605=电磁光材料
- 606=铌铽合金, 607=液态铌铽, 608=高纯氟化钬, 609=变质角闪片岩, 610=热电光材料
- 611=铌钐合金, 612=液态铌钐, 613=高纯氟化铒, 614=绿泥片麻岩, 615=声电磁材料
- 616=铌铕合金, 617=液态铌铕, 618=高纯氟化钆, 619=滑石片麻岩, 620=光热磁材料
- 621=铌钆合金, 622=液态铌钆, 623=高纯氟化钐, 624=蛇纹片麻岩, 625=磁声光材料
- 626=铌钬合金, 627=液态铌钬, 628=高纯氟化铽, 629=正长片麻岩, 630=热声光材料
- 631=铌铒合金, 632=液态铌铒, 633=高纯氟化镥, 634=皂石片麻岩, 635=声热光材料
- 636=铌镥合金, 637=液态铌镥, 638=高纯氟化钪, 639=辉石片麻岩, 640=电声光材料
- 641=铌钌合金, 642=液态铌钌, 643=高纯氟化镨, 644=橄榄片麻岩, 645=磁电声材料
- 646=铌钪合金, 647=液态铌钪, 648=高纯氟化镱, 649=石榴片麻岩, 650=热电声材料
- 新材质只需：创建文件 → 实现 MaterialDef → registerMaterial() → main.ts 导入

### 性能优化
- 双缓冲活跃标记：set/swap 自动唤醒 3x3 邻域
- 静止粒子（已堆积的沙子、石头、金属等）跳过更新

## 技术边界
- 浏览器可运行（无需后端）
- 纯前端实现
- 代码可维护、可扩展

## 自主决策权
你自己决定：
1. **开发节奏**：分几个迭代周期，每个周期做什么
2. **技术选型**：用 Canvas/WebGL，数据结构如何设计
3. **物理精度**：像素级/网格级，模拟复杂度多少
4. **材质系统**：先做哪些材质，化学反应规则如何设计
5. **UI 设计**：控制面板、工具栏、交互方式
6. **优化策略**：何时优化、如何优化、性能目标

## 规范体系
- `.agent/rules/` — Awesome AGV 代码质量规则（30条）
- `.agent/skills/` — 开发技能（代码审查、调试、架构等）
- `.agent/workflows/` — 工作流程（研究→实现→集成→验证→提交）
- `.claude/commands/opsx/` — OpenSpec 功能规划命令
- 使用 `/opsx:propose` 规划新功能，`/opsx:apply` 实施

## 开发规范
- 每个功能一个原子 commit（feat/fix/refactor: 描述）
- 代码质量检查必须通过（tsc --noEmit + vite build）
- 构建必须成功
- 每次 commit 后 git push origin main（确保远程同步）
- 代码要有清晰注释

## 迭代原则
每轮迭代完成后自我评估：
1. 当前版本完成了什么？
2. 有什么明显的问题或瓶颈？
3. 下一个迭代周期应该优先解决什么？
4. 是否需要调整技术方向或架构？

## 持续关注
- 🎮 可玩性：用户能否轻松创造有趣的场景？
- ⚡ 性能：模拟是否流畅？能否支持更多粒子？
- 🎨 表现力：材质视觉效果是否清晰美观？
- 🔬 真实性：物理行为是否符合直觉？
- 🧩 扩展性：添加新材质/新规则是否容易？

## 输出要求
- 每次迭代提供完整可运行的代码
- 说明本次改动的核心内容
- 说明已知局限和下一步计划
- 代码要有清晰注释

## 📄 文档同步（每轮必做）
- 根据当前 git 状态和项目进展，更新以下文件：
  - CLAUDE.md — 项目规范、架构说明、开发约定
  - README.md — 项目介绍、功能列表、使用说明
  - .agent/skills/ 或 openspec/specs/ — 如有新功能模块，补充对应的 skill 或 spec
- 文档更新也要 commit（docs: 更新 xxx）
