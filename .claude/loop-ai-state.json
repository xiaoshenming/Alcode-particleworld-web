{
  "notes": "第88轮（迭代12）：消除所有 const neighbors 绝对坐标数组，改用 DIRS4/DIRS8 相对坐标迭代。\n\n1. 【验证上轮工作】\n   - tsc --noEmit：通过（已有成果干净）\n   - do...while(false) 展开逻辑正确：break 等价于原来的 continue（只跳过当前 do 块，不影响外层循环）\n   - new Set/Map/Array 全部已在模块级别，无 update() 内临时对象\n\n2. 【性能优化】25个文件消除 const neighbors 绝对坐标数组：\n   - 17个标准DIRS4文件（Python脚本批量替换）：Snow/Glass/Ice/Wax/IceCrystal/MudBrick/Alum/Tungsten/Antimony/Dirt/FireworkShell/Glycerin/Lava/MoltenAntimony/MoltenWax/Philosopher/Salt\n   - 3个DIRS8文件（手动修复）：Hydrogen/Krypton/Gunpowder\n   - 2个DIRS8多行格式（手动修复）：Fire/PhosphorusFire\n   - 2个非标准顺序DIRS4（手动修复）：Acid/Saltwater\n   - 1个特殊情况（ignited变量在中间）：Firework\n\n3. 【模式说明】\n   - 标准DIRS4：const neighbors=[x,y-1],[x,y+1],[x-1,y],[x+1,y]] → for(const [dx,dy] of DIRS4) { const nx=x+dx, ny=y+dy;\n   - DIRS8：两行4+4坐标 → for(const [dx,dy] of DIRS8) { const nx=x+dx, ny=y+dy;\n   - 非标准顺序：也可以直接替换为DIRS4（只是迭代顺序不同，不影响正确性）\n\n4. 【验证】\n   - tsc --noEmit 通过\n   - vite build 成功，bundle: 1464.97KB（略微减少）\n   - grep确认0个 const neighbors 仍剩余\n\n5. 【新材质确认】ID 1226~1250 所有文件已正确导入 main.ts\n\nbundle: 1464.97KB",
  "priorities": [
    "1. 检查其他可能的每帧临时对象：Array.from()、Object.keys()、filter/map/reduce 在 update() 内调用",
    "2. 检查 Electrochromic.ts poweredSet 的使用模式，每帧添加删除是否有性能问题",
    "3. 关注新材质批次（ID 1251+）的添加，确保使用 DIRS4/DIRS8 共享常量，不引入内联数组",
    "4. 考虑是否可以进一步减少 bundle 大小（代码展开导致比原始增加了30KB）",
    "5. 检查 Thermoplastic.ts softened Set 是否每帧清空重填（如果是则有性能问题）"
  ],
  "lessons": "1. tickAge()会干扰任何没有每帧调用setAge()的age用法。只有两种安全的age使用模式：\n   (a) 只读+自动递增：只调getAge，依赖tickAge递增（Clay/Lightning/Smoke等）\n   (b) 手动管理：每帧调setAge，阻止tickAge干扰（Fire/Wire/Clone等）\n2. set(x, y, id) 会重置 _age[i]=0。因此：\n   - 如果 if(age===0){setAge(init)} 后面立即有 set()+setAge()，init分支的 setAge 是冗余的\n3. 全局 Map 状态（Ant.antStates, Portal.portalPairs）必须在所有 world.clear()/load()/restoreFromSnapshot() 调用时同步清理。\n4. 批量替换技巧：Python 正则脚本可以安全处理大量文件的模式替换，但需要：\n   (a) 同时更新 import 语句\n   (b) 替换后必须立即运行 tsc --noEmit 验证\n   (c) 注意 continue 在普通块中无效，需要用 do...while(false) + break 替代\n5. 共享常量应标注 ReadonlyArray 类型，防止意外修改共享状态。\n6. update()内的临时对象创建（new Set/Map/Array）应移到模块级别。\n7. DIRS4 + DIRS_DIAG = DIRS8，可以直接用DIRS8替代 [...DIRS4, ...DIRS_DIAG] 的spread合并\n8. 随机方向遍历：随机起始索引+循环 比 sort() 更高效（无数组分配）\n9. for(const d of [dir, -dir]) 每帧创建2元素数组，应展开为两个独立块\n10. do...while(false) 是 TypeScript 中实现「块级 continue」的标准模式\n11. 检查spread操作符的方法：grep -rn '\\.\\.\\.' src/materials/ --include='*.ts' | grep -v 'const [A-Z_]* = \\[' | grep -v '//'\n12. 绝对坐标 neighbors 数组（[[x,y-1],...]）每帧创建一个数组，应替换为 DIRS4/DIRS8 相对坐标迭代\n13. 非标准坐标顺序的 neighbors 数组同样可以替换为DIRS4（顺序不影响逻辑正确性，只影响处理顺序）\n14. Python 脚本批量处理文件前，先用 grep 列出所有目标文件，然后逐一验证模式是否匹配，处理完后立即 tsc 验证",
  "last_updated": "2026-02-28T19:30:00+08:00"
}
