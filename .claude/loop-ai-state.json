{
  "notes": "第89轮（迭代13）：消除 Thermoplastic/Portal/Ant 的字符串key每帧分配，改用数字key。\n\n1. 【验证上轮工作】\n   - tsc --noEmit：通过\n   - 新材质文件（ID 1226~1250）已在之前会话提交，git status 干净\n   - 无 const neighbors 残留，无 for(const d of [dir,-dir]) 残留\n\n2. 【性能优化】3个文件消除字符串key每帧分配：\n   - Thermoplastic.ts：softened Set<string> → Set<number>，key函数 `${x},${y}` → y*_width+x\n   - Portal.ts：portalPairs Map<string,string> → Map<number,number>，parseKey 改为数学运算\n   - Ant.ts：antStates Map<string,AntState> → Map<number,AntState>，key函数改为数字\n   - 三个文件均缓存 world.width 到模块级变量（_width/_portalWidth/_antWidth），首次update时更新\n\n3. 【检查结果】\n   - Array.from/Object.keys/filter/map/reduce：仅在 registry.ts 中（非update()），无问题\n   - Electrochromic.ts poweredSet：已是数字key，用performance.now()间隔清除，模式正常\n   - 无其他字符串操作在update()内\n   - 新材质文件无旧模式（const neighbors / for(const d of [dir,-dir])）\n\n4. 【验证】\n   - tsc --noEmit 通过\n   - vite build 成功，bundle: 1464.95KB（略减）\n\nbundle: 1464.95KB",
  "priorities": [
    "1. 检查是否有其他 Map/Set 使用字符串key的文件（Termite/Firefly/Virus等有状态的生物材质）",
    "2. 检查 Electrochromic.ts 的 performance.now() 帧清除逻辑是否可以改为基于 world 帧计数器（更精确）",
    "3. 关注新材质批次（ID 1251+）的添加，确保使用 DIRS4/DIRS8 共享常量，不引入内联数组",
    "4. 考虑是否可以进一步减少 bundle 大小（当前1464.95KB）",
    "5. 检查 Termite.ts 是否有字符串key或其他每帧分配问题"
  ],
  "lessons": "1. tickAge()会干扰任何没有每帧调用setAge()的age用法。只有两种安全的age使用模式：\n   (a) 只读+自动递增：只调getAge，依赖tickAge递增（Clay/Lightning/Smoke等）\n   (b) 手动管理：每帧调setAge，阻止tickAge干扰（Fire/Wire/Clone等）\n2. set(x, y, id) 会重置 _age[i]=0。因此：\n   - 如果 if(age===0){setAge(init)} 后面立即有 set()+setAge()，init分支的 setAge 是冗余的\n3. 全局 Map 状态（Ant.antStates, Portal.portalPairs）必须在所有 world.clear()/load()/restoreFromSnapshot() 调用时同步清理。\n4. 批量替换技巧：Python 正则脚本可以安全处理大量文件的模式替换，但需要：\n   (a) 同时更新 import 语句\n   (b) 替换后必须立即运行 tsc --noEmit 验证\n   (c) 注意 continue 在普通块中无效，需要用 do...while(false) + break 替代\n5. 共享常量应标注 ReadonlyArray 类型，防止意外修改共享状态。\n6. update()内的临时对象创建（new Set/Map/Array）应移到模块级别。\n7. DIRS4 + DIRS_DIAG = DIRS8，可以直接用DIRS8替代 [...DIRS4, ...DIRS_DIAG] 的spread合并\n8. 随机方向遍历：随机起始索引+循环 比 sort() 更高效（无数组分配）\n9. for(const d of [dir, -dir]) 每帧创建2元素数组，应展开为两个独立块\n10. do...while(false) 是 TypeScript 中实现「块级 continue」的标准模式\n11. 检查spread操作符的方法：grep -rn '\\.\\.\\.' src/materials/ --include='*.ts' | grep -v 'const [A-Z_]* = \\[' | grep -v '//'\n12. 绝对坐标 neighbors 数组（[[x,y-1],...]）每帧创建一个数组，应替换为 DIRS4/DIRS8 相对坐标迭代\n13. 非标准坐标顺序的 neighbors 数组同样可以替换为DIRS4（顺序不影响逻辑正确性，只影响处理顺序）\n14. Python 脚本批量处理文件前，先用 grep 列出所有目标文件，然后逐一验证模式是否匹配，处理完后立即 tsc 验证\n15. 字符串key（`${x},${y}`）每帧创建字符串，应改为数字key（y * world.width + x），world.width 缓存到模块级变量\n16. 数字key反算坐标：x = key % width, y = key / width | 0（整数除法）",
  "last_updated": "2026-02-28T20:00:00+08:00"
}
