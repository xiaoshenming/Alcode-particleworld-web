{
  "notes": "第87轮（迭代11）：消除所有 for...of 内联数组分配，无新功能。\n\n1. 【性能优化】Cement/Ant/OilSand/Moss 4个文件消除内联数组：\n   - Cement.ts: const dirs = [[0,1],...] → DIRS4，for(const d of [dir,-dir]) → 两个独立if\n   - Ant.ts: [[0,-1],...] → DIRS4\n   - OilSand.ts: [[-1,-1],[1,-1]] → 模块级常量 DIRS_UPPER_DIAG\n   - Moss.ts: 两处内联数组 → DIRS4 + 随机起始索引循环\n\n2. 【性能优化】258个文件批量消除 for(const d of [dir,-dir]) 每帧数组分配：\n   - 使用Python脚本批量替换\n   - 无 continue 的循环 → 两个独立 { const d = dir/−dir; ... } 块\n   - 有 continue 的循环 → 两个 do { const d = dir/−dir; ... } while(false) 块（continue→break）\n   - 第一次脚本用普通块，tsc报错（continue不能在普通块中）\n   - 修复脚本后重新运行，tsc通过\n\n3. 【验证】\n   - tsc --noEmit 通过\n   - vite build 成功，bundle: 1465.75KB（+31KB，因代码展开）\n   - 所有 for...of 内联数组已消除（grep确认0个）\n\n4. 【代码审查】\n   - diffuseTemperature() 需要全遍历（热量扩散到邻居），无法只处理活跃区域\n   - tickAge() 已经用 _awake 过滤，已经很优化\n   - 所有新材质（钯系列、高纯氟化物系列）已正确导入 main.ts\n\nbundle: 1465.75KB（代码展开导致增加，但消除了每帧GC压力）",
  "priorities": [
    "1. 检查是否还有其他 update() 内的临时对象（对象字面量 {}、new Array() 等）",
    "2. 检查绝对坐标 neighbors 数组（Dirt/Snow/Ice 等文件）是否值得改为相对坐标+DIRS4模式",
    "3. 关注新材质批次（ID 1251+）的添加，确保使用 DIRS4/DIRS8 共享常量",
    "4. 检查 do...while(false) 展开是否有逻辑问题（continue→break 是否正确）",
    "5. 考虑是否可以进一步减少 bundle 大小（代码展开导致增加了31KB）"
  ],
  "lessons": "1. tickAge()会干扰任何没有每帧调用setAge()的age用法。只有两种安全的age使用模式：\n   (a) 只读+自动递增：只调getAge，依赖tickAge递增（Clay/Lightning/Smoke等）\n   (b) 手动管理：每帧调setAge，阻止tickAge干扰（Fire/Wire/Clone等）\n2. set(x, y, id) 会重置 _age[i]=0。因此：\n   - 如果 if(age===0){setAge(init)} 后面立即有 set()+setAge()，init分支的 setAge 是冗余的\n3. 全局 Map 状态（Ant.antStates, Portal.portalPairs）必须在所有 world.clear()/load()/restoreFromSnapshot() 调用时同步清理。\n4. 批量替换技巧：Python 正则脚本可以安全处理大量文件的模式替换，但需要：\n   (a) 同时更新 import 语句\n   (b) 替换后必须立即运行 tsc --noEmit 验证\n   (c) 注意 continue 在普通块中无效，需要用 do...while(false) + break 替代\n5. 共享常量应标注 ReadonlyArray 类型，防止意外修改共享状态。\n6. update()内的临时对象创建（new Set/Map/Array）应移到模块级别。\n7. DIRS4 + DIRS_DIAG = DIRS8，可以直接用DIRS8替代 [...DIRS4, ...DIRS_DIAG] 的spread合并\n8. 随机方向遍历：随机起始索引+循环 比 sort() 更高效（无数组分配）\n9. for(const d of [dir, -dir]) 每帧创建2元素数组，应展开为两个独立块\n10. do...while(false) 是 TypeScript 中实现「块级 continue」的标准模式\n11. 检查spread操作符的方法：grep -rn '\\.\\.\\.' src/materials/ --include='*.ts' | grep -v 'const [A-Z_]* = \\[' | grep -v '//'",
  "last_updated": "2026-02-28T18:30:00+08:00"
}
