{
  "notes": "第90轮（迭代14）：全面检查性能优化完成度，确认无遗留问题。\n\n1. 【验证上轮工作】\n   - tsc --noEmit：通过\n   - git status：干净（无未提交的新材质文件）\n   - 第89轮的 Thermoplastic/Portal/Ant 字符串key优化已提交\n\n2. 【全面性能检查】\n   - Map<string, ...> / Set<string>：无（仅在注释中）\n   - 字符串key模板字面量 `${x},${y}`：无\n   - update()内临时对象创建（new Map/Set/Array）：无（所有在模块级别）\n   - spread操作符 [...]：无（已在第86-88轮清除）\n   - 高阶函数（filter/map/reduce）：仅在 registry.ts（非update()），无问题\n   - 字符串解析（split/parseInt/JSON）：无\n   - 有状态材质（Termite/Virus/Firefly/Wire）：均使用 World 内置 age 系统，无字符串key\n\n3. 【Electrochromic.ts 检查】\n   - poweredSet 已是 Set<number>（数字key）\n   - performance.now() 每50ms清除一次（约3帧），可接受\n   - 虽然不完美（可能在帧中途清除），但不会造成严重问题\n   - WorldAPI 无帧计数器，无法改进\n\n4. 【其他时间调用检查】\n   - Bismuth.ts：setInterval 用于 color() 中的彩虹渐变，不在 update() 内\n   - GlowStick/Opal/GlowAlgae/RainbowLiquid：Date.now() 用于 color()，不在 update() 内\n   - 均不产生每帧GC压力\n\n5. 【代码重复度分析】\n   - 1234个材质文件，107387行代码，5.1MB源码\n   - bundle 1464.95KB（压缩比28.7%）\n   - 大量重复逻辑（温度检查697次，生成烟186次，着火71次）\n   - 但提取辅助函数会增加函数调用开销，当前内联模式正确\n\n6. 【验证】\n   - tsc --noEmit 通过\n   - vite build 成功，bundle: 1464.95KB（与第89轮相同）\n\n7. 【结论】\n   - 所有已知性能优化已完成\n   - 无遗留的每帧分配问题\n   - 无需进一步优化\n\nbundle: 1464.95KB",
  "priorities": [
    "1. 监控新材质批次（ID 1251+）的添加，确保使用 DIRS4/DIRS8 共享常量，不引入内联数组",
    "2. 如有新功能需求，优先使用 /opsx:propose 规划，确保架构合理",
    "3. 定期检查 git status，及时提交新材质文件",
    "4. 关注用户反馈，修复 bug 和性能问题",
    "5. 考虑是否需要添加新的材质交互规则或物理效果"
  ],
  "lessons": "1. tickAge()会干扰任何没有每帧调用setAge()的age用法。只有两种安全的age使用模式：\n   (a) 只读+自动递增：只调getAge，依赖tickAge递增（Clay/Lightning/Smoke等）\n   (b) 手动管理：每帧调setAge，阻止tickAge干扰（Fire/Wire/Clone等）\n2. set(x, y, id) 会重置 _age[i]=0。因此：\n   - 如果 if(age===0){setAge(init)} 后面立即有 set()+setAge()，init分支的 setAge 是冗余的\n3. 全局 Map 状态（Ant.antStates, Portal.portalPairs）必须在所有 world.clear()/load()/restoreFromSnapshot() 调用时同步清理。\n4. 批量替换技巧：Python 正则脚本可以安全处理大量文件的模式替换，但需要：\n   (a) 同时更新 import 语句\n   (b) 替换后必须立即运行 tsc --noEmit 验证\n   (c) 注意 continue 在普通块中无效，需要用 do...while(false) + break 替代\n5. 共享常量应标注 ReadonlyArray 类型，防止意外修改共享状态。\n6. update()内的临时对象创建（new Set/Map/Array）应移到模块级别。\n7. DIRS4 + DIRS_DIAG = DIRS8，可以直接用DIRS8替代 [...DIRS4, ...DIRS_DIAG] 的spread合并\n8. 随机方向遍历：随机起始索引+循环 比 sort() 更高效（无数组分配）\n9. for(const d of [dir, -dir]) 每帧创建2元素数组，应展开为两个独立块\n10. do...while(false) 是 TypeScript 中实现「块级 continue」的标准模式\n11. 检查spread操作符的方法：grep -rn '\\.\\.\\.' src/materials/ --include='*.ts' | grep -v 'const [A-Z_]* = \\[' | grep -v '//'\n12. 绝对坐标 neighbors 数组（[[x,y-1],...]）每帧创建一个数组，应替换为 DIRS4/DIRS8 相对坐标迭代\n13. 非标准坐标顺序的 neighbors 数组同样可以替换为DIRS4（顺序不影响逻辑正确性，只影响处理顺序）\n14. Python 脚本批量处理文件前，先用 grep 列出所有目标文件，然后逐一验证模式是否匹配，处理完后立即 tsc 验证\n15. 字符串key（`${x},${y}`）每帧创建字符串，应改为数字key（y * world.width + x），world.width 缓存到模块级变量\n16. 数字key反算坐标：x = key % width, y = key / width | 0（整数除法）\n17. 性能优化已完成：所有每帧分配问题已清除，bundle大小稳定在1464.95KB\n18. 代码重复是可接受的：内联重复逻辑比提取辅助函数更高效（避免函数调用开销）",
  "last_updated": "2026-02-28T21:00:00+08:00"
}
