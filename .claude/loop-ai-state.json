{
  "notes": "第86轮（迭代10）：消除所有剩余的每帧数组分配，无新功能。\n\n1. 【性能优化】8个文件将[...DIRS4].sort()改为随机起始索引循环：\n   - Coral.ts: const dirs = [...DIRS4] → DIRS4，sort+loop → 随机起始循环\n   - Crystal.ts: 同上\n   - Foam.ts: 同上\n   - Mycelium.ts: 同上\n   - Mushroom.ts: 同上（两处sort+loop都替换）\n   - Clone.ts: const dirs = [...DIRS8] → DIRS8，sort+loop → 随机起始循环\n   - Portal.ts: exitDirs = [...DIRS4] + sort → 随机起始循环\n   - DielectricElastomer.ts: allDirs = [...DIRS8] + sort → 随机起始循环\n\n2. 【性能优化】Termite.ts 最后一个spread副本：\n   - [...allDirs].sort() → 随机起始索引循环\n   - 这是本轮发现的额外优化点\n\n3. 【验证】\n   - tsc --noEmit 通过\n   - vite build 成功，bundle: 1434.76KB\n   - 所有spread副本已消除（grep确认只剩0个）\n\n4. 【代码审查】\n   - World.ts 热路径已经很优化（直接缓冲区访问、rowBase预计算）\n   - Simulation.ts 热路径已经很优化\n   - 新材质文件（钯系列、高纯氟化物系列）已在之前会话提交\n   - 所有新材质正确使用DIRS4/DIRS8共享常量\n\nbundle: 1434.76KB（与上轮基本持平）",
  "priorities": [
    "1. 检查是否还有其他update()内的临时对象创建（new Map、new Array、对象字面量等）",
    "2. 检查绝对坐标neighbors数组（Dirt/Snow/Ice等26个文件）是否值得改为相对坐标+DIRS4模式",
    "3. 关注新材质批次（ID 1251+）的添加，确保使用DIRS4/DIRS8共享常量而非内联数组",
    "4. 检查diffuseTemperature()是否可以进一步优化（如只处理活跃区域）",
    "5. 检查tickAge()是否可以进一步优化（如只处理活跃粒子）"
  ],
  "lessons": "1. tickAge()会干扰任何没有每帧调用setAge()的age用法。只有两种安全的age使用模式：\n   (a) 只读+自动递增：只调getAge，依赖tickAge递增（Clay/Lightning/Smoke等）\n   (b) 手动管理：每帧调setAge，阻止tickAge干扰（Fire/Wire/Clone等）\n2. set(x, y, id) 会重置 _age[i]=0。因此：\n   - 如果 if(age===0){setAge(init)} 后面立即有 set()+setAge()，init分支的 setAge 是冗余的\n   - 结论：任何在 set() 之前的 setAge 如果后面紧接着 set()+setAge，前者都是冗余的\n3. 全局 Map 状态（Ant.antStates, Portal.portalPairs）必须在所有 world.clear()/load()/restoreFromSnapshot() 调用时同步清理。\n4. 批量替换技巧：Python 正则脚本可以安全处理大量文件的模式替换，但需要：\n   (a) 同时更新 import 语句（区分 import type 和 import）\n   (b) 注意 ReadonlyArray 不能调用 sort()，需要 [...DIRS4].sort() 创建副本\n   (c) 替换后必须立即运行 tsc --noEmit 验证，不要等到最后\n   (d) 注意脚本可能引入双分号等副作用，需要额外检查\n5. 共享常量应标注 ReadonlyArray 类型，防止意外修改共享状态。如果需要修改，必须先 [...arr] 复制。\n6. update()内的临时对象创建（new Set/Map/Array）应移到模块级别。检查方法：\n   - 找到update函数体起始位置\n   - 在函数体内搜索 new Set/Map/Array\n   - 如果是固定内容（不依赖x/y参数），移到模块级别\n7. DIRS4 + DIRS_DIAG = DIRS8，可以直接用DIRS8替代 [...DIRS4, ...DIRS_DIAG] 的spread合并\n8. 随机方向遍历的两种方式：\n   (a) [...DIRS4].sort(() => Math.random() - 0.5) — 真随机排列，每帧分配数组\n   (b) 随机起始索引+循环 — 随机起始但相对顺序固定，无数组分配（更高效）\n   对于「找随机空位」的场景，(b)效果等价且更高效\n9. 当一个文件中有多个随机起始循环时，需要用不同变量名（start, start2等）避免冲突\n10. 检查spread操作符的方法：grep -rn '\\.\\.\\.' src/materials/ --include='*.ts' | grep -v 'const [A-Z_]* = \\[' | grep -v '//'",
  "last_updated": "2026-02-28T18:00:00+08:00"
}
